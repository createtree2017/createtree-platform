# 병원 회원 등급 자동화 시스템 테스트 가이드

## 📋 시스템 개요

병원 활성화/비활성화 시 자동으로 회원 등급을 조정하는 시스템입니다.

### 🎯 자동화 규칙
- **병원 활성화**: 소속 회원들 → `pro` 등급으로 승격
- **병원 비활성화**: 소속 회원들 → `free` 등급으로 변경
- **관리자 등급 제외**: `admin`, `superadmin`, `hospital_admin`은 변경되지 않음

## 🔧 올바른 테스트 방법

### ✅ 올바른 API 호출 방법

```typescript
// 올바른 테스트 - API를 통한 병원 상태 변경
const response = await fetch(`/api/admin/hospitals/${hospitalId}/status`, {
  method: 'PATCH',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${adminToken}`
  },
  body: JSON.stringify({
    isActive: false  // 비활성화
  })
});
```

### ❌ 잘못된 테스트 방법

```typescript
// 잘못된 테스트 - DB 직접 수정 (자동화 우회)
await db.update(hospitals)
  .set({ isActive: false })
  .where(eq(hospitals.id, hospitalId));
// 이 방법은 자동화 트리거를 우회하므로 회원 등급이 변경되지 않음
```

## 🧪 실제 테스트 시나리오

### 1. 관리자 로그인 및 권한 확인
```bash
# 관리자로 로그인 (superadmin 또는 admin 권한 필요)
POST /api/auth/login
{
  "username": "관리자계정",
  "password": "비밀번호"
}
```

### 2. 테스트 대상 병원 선택
```bash
# 활성화된 병원 중 membership 회원이 있는 병원 선택
GET /api/admin/hospitals
GET /api/admin/users?hospitalId=1&memberType=membership
```

### 3. 병원 비활성화 테스트
```bash
# 병원 비활성화 API 호출
PATCH /api/admin/hospitals/1/status
{
  "isActive": false
}

# 예상 응답:
{
  "success": true,
  "hospital": { ... },
  "message": "병원이 비활성화되었으며, 소속 회원들이 free 등급으로 변경되었습니다"
}
```

### 4. 자동화 결과 확인
```bash
# 회원 등급 변경 확인
GET /api/admin/users?hospitalId=1

# 로그 확인 (서버 콘솔)
[자동화 트리거] 병원 상태 변경 감지 - 회원 등급 자동 변경 시작
[자동화 트리거] 병원 소속 회원 현황:
  - membership 회원: 2명
  - 기존 변경된 회원 (pro/free): 0명
[자동화 트리거] 목표 등급: free (병원 비활성화)
[자동화 트리거] user@example.com (ID: 31) - membership → free 변경 완료
[자동화 트리거] 총 2명의 회원 등급 변경 완료
```

### 5. 병원 재활성화 테스트
```bash
# 병원 재활성화
PATCH /api/admin/hospitals/1/status
{
  "isActive": true
}

# 회원 등급이 다시 pro로 변경되는지 확인
GET /api/admin/users?hospitalId=1
```

## 📊 로그 모니터링

### 서버 콘솔에서 확인할 수 있는 로그들:

```
[병원 상태 변경] 병원 ID: 1, 새 상태: 비활성화
[병원 상태 변경] 우성여성병원 상태 변경 완료
[자동화 트리거] 병원 상태 변경 감지 - 회원 등급 자동 변경 시작
[자동화 트리거] 병원 소속 회원 현황:
  - membership 회원: 2명
  - 기존 변경된 회원 (pro/free): 0명
[자동화 트리거] 목표 등급: free (병원 비활성화)
[자동화 트리거] user1@example.com (ID: 31) - membership → free 변경 완료
[자동화 트리거] user2@example.com (ID: 32) - membership → free 변경 완료
[자동화 트리거] 총 2명의 회원 등급 변경 완료
```

## 🔍 테스트 체크리스트

### 병원 비활성화 테스트
- [ ] 관리자 권한으로 로그인
- [ ] 테스트 대상 병원의 membership 회원 확인
- [ ] `/api/admin/hospitals/{id}/status` API 호출로 비활성화
- [ ] 서버 로그에서 자동화 트리거 실행 확인
- [ ] 소속 회원들의 등급이 `free`로 변경되었는지 확인
- [ ] 관리자 등급 사용자는 변경되지 않았는지 확인

### 병원 활성화 테스트
- [ ] 동일한 병원을 다시 활성화
- [ ] 소속 회원들의 등급이 `pro`로 변경되었는지 확인
- [ ] 응답 메시지가 올바른지 확인

## ⚠️ 주의사항

1. **직접 DB 수정 금지**: 반드시 API를 통해서만 테스트
2. **관리자 권한 필요**: `requireAdminOrSuperAdmin` 미들웨어 통과 필요
3. **로그 모니터링**: 자동화 실행 과정을 서버 콘솔에서 확인
4. **롤백 계획**: 테스트 후 원래 상태로 복구하는 계획 수립

## 🎯 성공 기준

자동화 시스템이 올바르게 작동하는 경우:
- ✅ API 호출 시 200 응답
- ✅ 서버 로그에 자동화 트리거 실행 메시지
- ✅ 소속 회원들의 등급이 예상대로 변경
- ✅ 관리자 등급 사용자는 제외
- ✅ 적절한 성공 메시지 반환

## 📝 테스트 스크립트 예시

올바른 테스트 스크립트 작성 시 참고:

```typescript
// 올바른 테스트 스크립트 예시
async function testHospitalMembershipAutomation() {
  // 1. 관리자 로그인
  const loginResponse = await apiRequest('/api/auth/login', {
    method: 'POST',
    body: { username: 'admin', password: 'password' }
  });
  
  // 2. 병원 상태 변경 (API 호출)
  const statusResponse = await apiRequest('/api/admin/hospitals/1/status', {
    method: 'PATCH',
    body: { isActive: false }
  });
  
  // 3. 결과 확인
  const usersResponse = await apiRequest('/api/admin/users?hospitalId=1');
  
  console.log('자동화 테스트 결과:', {
    statusChanged: statusResponse.success,
    membersUpdated: usersResponse.users.filter(u => u.memberType === 'free').length
  });
}
```

이 가이드를 따라 테스트하면 병원 회원 등급 자동화 시스템이 올바르게 작동하는 것을 확인할 수 있습니다.