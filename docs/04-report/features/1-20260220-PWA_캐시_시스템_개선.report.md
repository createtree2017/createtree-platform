# PWA 캐시 시스템 개선 — 완료 보고서

## 기본 정보
- **기능명**: PWA 캐시 시스템 개선
- **작성일**: 2026-02-20
- **Plan 문서**: `docs/01-plan/features/1-20260220-PWA_캐시_시스템_개선.plan.md`
- **상태**: ✅ 구현 완료

## 문제 요약
- iOS PWA에서 새 배포 후에도 구 버전 앱이 표시됨
- 서비스 워커 캐시 버전이 `v2025102201` (약 4개월 전)로 고정
- JS/CSS 파일이 `cacheFirst` 전략으로 서빙되어 새 파일 불러오기 안 됨
- 안드로이드에서도 당겨서 새로고침 필요

## 변경 내역

### 1. `client/public/sw.js` — 캐시 버전 + 전략 변경
| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 캐시 버전 | `v2025102201` | `v2026022001` |
| JS/CSS 캐시 전략 | `cacheFirst` (캐시 우선) | `networkFirst` (네트워크 우선) |

- `isStaticAsset()`에서 `.js`, `.css`를 제거 → 이제 `networkFirst`로 처리됨
- 새 SW 설치 시 `activate` 이벤트에서 구 캐시 자동 삭제

### 2. `client/src/utils/pwa.ts` — 앱 복귀 시 자동 업데이트 체크
- `visibilitychange` 이벤트로 앱 복귀(탭 전환, 화면 켜짐) 감지
- 복귀 시 `checkForUpdates()` 자동 호출 → 새 SW 발견 시 알림

### 3. `client/src/components/PWAUpdatePrompt.tsx` — 업데이트 프로세스 강화
| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 업데이트 방식 | 단순 `window.location.reload()` | SW에 `SKIP_WAITING` → 새 SW 활성화 → 자동 새로고침 |
| 자동 새로고침 | 없음 | `controllerchange` 이벤트 리스닝 |
| UI 문구 | "업데이트 사용 가능" | "새 버전이 있습니다" |

## 동작 흐름 (배포 후)

```
사용자가 앱 열기/복귀
    ↓
visibilitychange → checkForUpdates()
    ↓
새 sw.js 감지 (브라우저가 바이트 비교)
    ↓
updatefound 이벤트 → "새 버전이 있습니다" 토스트
    ↓
사용자가 "지금 업데이트" 터치
    ↓
SKIP_WAITING → 새 SW 활성화 → controllerchange → 자동 새로고침
    ↓
새 SW가 구 캐시 삭제 → 최신 파일 로드
```

## 영향 범위
- ✅ iOS PWA: 구 버전 문제 해결
- ✅ Android PWA: 당겨서 새로고침 불필요
- ✅ 데스크톱 브라우저: 동일 적용
- ⚠️ 오프라인 모드: JS/CSS가 `networkFirst`이므로 오프라인 시 캐시된 버전 사용 (기존과 동일)

## 다음 배포 시 주의사항
- `sw.js`의 캐시 버전(`CACHE_NAME` 등)을 배포마다 업데이트 필요
- 향후 Vite 빌드 시 자동 버전 업데이트 자동화 고려
