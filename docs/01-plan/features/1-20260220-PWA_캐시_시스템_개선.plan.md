# PWA 캐시 시스템 개선 계획서

## 개요
- **기능명**: PWA 캐시 시스템 개선
- **작성일**: 2026-02-20
- **목표**: iOS PWA에서 예전 버전이 계속 표시되는 문제를 근본적으로 해결

## 배경
- iOS PWA에서 새 배포 후에도 구 버전 앱이 표시됨
- 안드로이드에서는 당겨서 새로고침으로 해결되지만, iOS에서는 이 기능이 지원되지 않음
- 사용자에게 "캐시를 삭제하세요"라고 안내하는 것은 UX가 나쁨
- **근본 원인**: 서비스 워커(`sw.js`)의 캐시 버전이 `v2025102201` (약 4개월 전)로 고정되어 있고, 정적 자산(.js, .css)을 `cacheFirst` 전략으로 서빙하여 구 버전 파일이 계속 제공됨

## 범위

### 포함
1. **서비스 워커 캐시 버전 업데이트** — 구 캐시 강제 삭제
2. **정적 자산 캐시 전략 변경** — `cacheFirst` → `networkFirst`
3. **자동 업데이트 알림 UI** — 새 버전 감지 시 사용자에게 알림

### 제외
- GCS 이미지/음악 캐시 변경 (컨텐츠 파일은 장기 캐시 유지가 적절)
- Pull-to-Refresh 직접 구현 (이번 개선으로 불필요해짐)

## 기술 요구사항

### Frontend
- `client/public/sw.js` — 캐시 버전 업데이트 + 캐시 전략 변경
- `client/src/utils/pwa.ts` — 앱 포커스 시 자동 업데이트 체크 추가
- `client/src/components/UpdateNotification.tsx` — [신규] 업데이트 알림 토스트 컴포넌트
- `client/src/App.tsx` — UpdateNotification 컴포넌트 추가

### Backend
- `server/index.ts` — 변경 없음 (이미 `index.html`에 `no-cache` 설정됨 ✅)

### Database
- 변경 없음

## 영향 범위
- 영향 받는 기존 기능: PWA 오프라인 모드 (캐시 전략 변경으로 일부 오프라인 기능 약화 가능)
- 수정 필요한 파일: `sw.js`, `pwa.ts`, `App.tsx` + 신규 `UpdateNotification.tsx`

## 예상 일정
- 예상 작업량: 1~2시간
- 우선순위: 높음 (사용자 경험 직결)

## 상세 구현 방안

### 1. sw.js 캐시 버전 업데이트
```diff
-const CACHE_NAME = 'hospital-ai-v2025102201';
-const STATIC_CACHE = 'static-v2025102201';
-const DYNAMIC_CACHE = 'dynamic-v2025102201';
-const IMAGE_CACHE = 'images-v2025102201';
-const MUSIC_CACHE = 'music-v2025102201';
+const CACHE_NAME = 'hospital-ai-v2026022001';
+const STATIC_CACHE = 'static-v2026022001';
+const DYNAMIC_CACHE = 'dynamic-v2026022001';
+const IMAGE_CACHE = 'images-v2026022001';
+const MUSIC_CACHE = 'music-v2026022001';
```
→ 새 SW가 설치되면서 `activate` 이벤트에서 구 캐시 자동 삭제

### 2. 정적 자산 캐시 전략 변경
`isStaticAsset` 함수에서 `.js`, `.css`를 제거하여 `networkFirst`로 처리되도록 변경.
Vite가 생성하는 해시 파일명(`index-abc123.js`)은 URL 자체가 바뀌므로 `networkFirst`가 안전함.

```diff
 function isStaticAsset(url) {
-  return url.pathname.includes('/static/') ||
-         url.pathname.includes('.css') ||
-         url.pathname.includes('.js') ||
-         url.pathname === '/manifest.json' ||
-         url.pathname === '/logo.svg';
+  return url.pathname === '/manifest.json' ||
+         url.pathname === '/logo.svg';
 }
```

### 3. 자동 업데이트 알림 UI
- 새 SW 감지 → 화면 하단에 토스트 표시: "새 버전이 있습니다. 터치하여 업데이트"
- 사용자가 터치하면 SW에 `SKIP_WAITING` 메시지 전송 → 페이지 자동 새로고침
- `pwa.ts`에 앱 복귀 시(visibilitychange) 자동 업데이트 체크 추가

## 검증 방법
1. 로컬 개발 서버에서 SW 변경사항 확인
2. 배포 후 iOS Safari/PWA에서 구 버전 → 신 버전 전환 테스트
3. UpdateNotification 컴포넌트 동작 확인

## 다음 단계
→ Plan 승인 후 바로 구현 진행
→ 구현 완료 후 `/check PWA_캐시_시스템_개선`으로 갭 분석
