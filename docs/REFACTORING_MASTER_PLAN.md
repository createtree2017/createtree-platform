# ğŸ—ï¸ ì°½ì¡°AI V2 ì‹œìŠ¤í…œ ë¦¬íŒ©í† ë§ ë§ˆìŠ¤í„° í”Œëœ

**í”„ë¡œì íŠ¸ ì½”ë“œëª…:** PHOENIX (ë¶ˆì‚¬ì¡° - ì¬íƒ„ìƒ)  
**ì‘ì„±ì¼:** 2025ë…„ 10ì›” 21ì¼  
**ì¤‘ìš”ë„:** âš ï¸ **CRITICAL** - ì‚¬ì—… ì„±íŒ¨ ê²°ì •  
**ì˜ˆìƒ ê¸°ê°„:** 7-10ì¼  
**ëª©í‘œ:** ì™„ë²½í•œ ìœ ì§€ë³´ìˆ˜ì„± + ì„±ëŠ¥ ìµœì í™” + ë¬´ê²°ì  ì‹œìŠ¤í…œ

---

## ğŸ“‹ ëª©ì°¨

1. [í”„ë¡œì íŠ¸ ê°œìš”](#1-í”„ë¡œì íŠ¸-ê°œìš”)
2. [í˜„í™© ë¶„ì„ (As-Is)](#2-í˜„í™©-ë¶„ì„-as-is)
3. [ëª©í‘œ êµ¬ì¡° (To-Be)](#3-ëª©í‘œ-êµ¬ì¡°-to-be)
4. [Phase 1: ê¸°ë°˜ êµ¬ì¶•](#4-phase-1-ê¸°ë°˜-êµ¬ì¶•)
5. [Phase 2: ë¼ìš°í„° ëŒ€ë¶„ë¦¬](#5-phase-2-ë¼ìš°í„°-ëŒ€ë¶„ë¦¬)
6. [Phase 3: ì„¸ë¶€ ì‹œìŠ¤í…œ ìˆ˜ì •](#6-phase-3-ì„¸ë¶€-ì‹œìŠ¤í…œ-ìˆ˜ì •)
7. [ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸](#7-ê²€ì¦-ì²´í¬ë¦¬ìŠ¤íŠ¸)
8. [ìœ ì§€ë³´ìˆ˜ ê°€ì´ë“œ](#8-ìœ ì§€ë³´ìˆ˜-ê°€ì´ë“œ)
9. [ê¸´ê¸‰ ë¡¤ë°± ì ˆì°¨](#9-ê¸´ê¸‰-ë¡¤ë°±-ì ˆì°¨)

---

## 1. í”„ë¡œì íŠ¸ ê°œìš”

### 1.1 ë¦¬íŒ©í† ë§ ë°°ê²½

**í˜„ì¬ ë¬¸ì œì :**
```
âŒ routes.ts íŒŒì¼: 9,293ì¤„ (ê´€ë¦¬ ë¶ˆê°€ëŠ¥)
âŒ ì¤‘ë³µ ì½”ë“œ: 100+ íŒ¨í„´
âŒ í•˜ë“œì½”ë”©: ë‹¤ìˆ˜ ìœ„ì¹˜ì— ì‚°ì¬
âŒ ë™ì  import: 31íšŒ (ì„±ëŠ¥ ì €í•˜)
âŒ console.log: 632ê°œ (í”„ë¡œë•ì…˜ ë…¸ì¶œ)
âŒ LSP ì—ëŸ¬: 12ê°œ (íƒ€ì… ë¶ˆì¼ì¹˜)
âŒ í•« ë¦¬ë¡œë“œ: 8-12ì´ˆ (ê°œë°œ ìƒì‚°ì„± ì €í•˜)
âŒ ë©”ëª¨ë¦¬ ì‚¬ìš©: ~20MB (ë‹¨ì¼ íŒŒì¼)
```

**ì‚¬ì—…ì  ì„íŒ©íŠ¸:**
- ì‹ ê·œ ê¸°ëŠ¥ ì¶”ê°€ ì‹œê°„: 2ì‹œê°„ â†’ 15ë¶„ (88% ë‹¨ì¶•)
- ë²„ê·¸ ìˆ˜ì • ì‹œê°„: 30ë¶„ â†’ 5ë¶„ (83% ë‹¨ì¶•)
- ì„œë²„ ë¹„ìš©: ë©”ëª¨ë¦¬ 75% ì ˆê°
- íŒ€ í˜‘ì—…: Git ì¶©ëŒ 70% ê°ì†Œ
- í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±: ë¶ˆê°€ëŠ¥ â†’ ê°€ëŠ¥

### 1.2 ì„±ê³µ ì§€í‘œ (KPI)

| ì§€í‘œ | í˜„ì¬ | ëª©í‘œ | ë‹¬ì„± ê¸°ì¤€ |
|------|------|------|----------|
| **routes.ts í¬ê¸°** | 9,293ì¤„ | â‰¤200ì¤„ | -98% |
| **í‰ê·  íŒŒì¼ í¬ê¸°** | - | â‰¤400ì¤„ | ê° ë¼ìš°í„° |
| **ì¤‘ë³µ ì½”ë“œ** | 100+ | 0 | 100% ì œê±° |
| **í•˜ë“œì½”ë”©** | ë‹¤ìˆ˜ | 0 | 100% ì œê±° |
| **ë™ì  import** | 31íšŒ | 0íšŒ | 100% ì œê±° |
| **console.log** | 632ê°œ | 0ê°œ | êµ¬ì¡°í™” ë¡œê¹… |
| **LSP ì—ëŸ¬** | 12ê°œ | 0ê°œ | íƒ€ì… ì•ˆì „ì„± |
| **í•« ë¦¬ë¡œë“œ** | 8-12ì´ˆ | 1-2ì´ˆ | -83% |
| **ë©”ëª¨ë¦¬ ì‚¬ìš©** | ~20MB | ~5MB | -75% |
| **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** | 0% | 60%+ | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ |

### 1.3 ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì „ëµ

#### ğŸ”´ High Risk
- **API ê²½ë¡œ ë³€ê²½**: ì ˆëŒ€ ê¸ˆì§€ (ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„±)
- **DB ìŠ¤í‚¤ë§ˆ ë³€ê²½**: ì‹ ì¤‘íˆ ê²€í†  í›„ ì§„í–‰
- **ì¸ì¦ ë¡œì§ ë³€ê²½**: ë³´ì•ˆ í…ŒìŠ¤íŠ¸ í•„ìˆ˜

#### ğŸŸ¡ Medium Risk
- **ë¯¸ë“¤ì›¨ì–´ ìˆœì„œ**: ë³€ê²½ ì‹œ ì „ì²´ í…ŒìŠ¤íŠ¸ í•„ìˆ˜
- **ì—ëŸ¬ í•¸ë“¤ë§**: ê¸°ì¡´ ë™ì‘ ìœ ì§€ í™•ì¸

#### ğŸŸ¢ Low Risk
- **ë‚´ë¶€ êµ¬ì¡° ë³€ê²½**: ì™¸ë¶€ ì¸í„°í˜ì´ìŠ¤ ë™ì¼í•˜ë©´ ì•ˆì „
- **ë¡œê¹… ê°œì„ **: ê¸°ëŠ¥ ì˜í–¥ ì—†ìŒ
- **ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜**: ë…ë¦½ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

---

## 2. í˜„í™© ë¶„ì„ (As-Is)

### 2.1 íŒŒì¼ êµ¬ì¡°

```
server/
â”œâ”€â”€ routes.ts                 âš ï¸ 9,293ì¤„ (ë¬¸ì œì˜ ê·¼ì›)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ milestones.ts        âš ï¸ 12ê°œ LSP ì—ëŸ¬
â”‚   â”œâ”€â”€ openai.ts
â”‚   â”œâ”€â”€ gemini.ts
â”‚   â””â”€â”€ topmedia-service.ts
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ music-engine-routes.ts    âœ… ë¶„ë¦¬ë¨
â”‚   â”œâ”€â”€ collage.ts                âœ… ë¶„ë¦¬ë¨
â”‚   â”œâ”€â”€ banner-migration.ts       âœ… ë¶„ë¦¬ë¨
â”‚   â”œâ”€â”€ google-oauth.ts           âœ… ë¶„ë¦¬ë¨
â”‚   â””â”€â”€ image-routes.ts           âœ… ë¶„ë¦¬ë¨
â””â”€â”€ middleware/
    â”œâ”€â”€ auth.ts
    â”œâ”€â”€ admin-auth.ts
    â””â”€â”€ permission.ts
```

### 2.2 ì¤‘ë³µ ì½”ë“œ ìƒì„¸ ë¶„ì„

#### A. userId ì¶”ì¶œ íŒ¨í„´ (14íšŒ ë°˜ë³µ)

**ìœ„ì¹˜:** routes.ts ì „ì—­
```typescript
// íŒ¨í„´ 1 (5íšŒ)
const userIdRaw = req.user?.userId || req.user?.id || req.user?.sub;
const userId = Number(userIdRaw);

// íŒ¨í„´ 2 (4íšŒ)
const userId = req.user?.id || req.user?.userId;
if (!userId) { return res.status(401).json(...) }

// íŒ¨í„´ 3 (5íšŒ)
const userId = String(req.user?.id || req.user?.userId);
```

**ë¬¸ì œì :**
- íƒ€ì… ë³€í™˜ ë¶ˆì¼ì¹˜ (Number vs String)
- ì—ëŸ¬ ì²˜ë¦¬ ì¤‘ë³µ
- ìœ ì§€ë³´ìˆ˜ ì‹œ 14ê³³ ìˆ˜ì • í•„ìš”

**í•´ê²°ì±…:** `server/utils/request-helpers.ts` í†µí•©

---

#### B. ë™ì  import íŒ¨í„´ (31íšŒ ë°˜ë³µ)

**ìœ„ì¹˜:** routes.ts ë§ˆì¼ìŠ¤í†¤ ê´€ë ¨ API
```typescript
// ê° APIë§ˆë‹¤ ë°˜ë³µ
const { getAllMilestones } = await import("./services/milestones");
const { getAvailableMilestones } = await import("./services/milestones");
const { completeMilestone } = await import("./services/milestones");
// ... 31íšŒ
```

**ë¬¸ì œì :**
- ê° ìš”ì²­ë§ˆë‹¤ 5-10ms ì¶”ê°€ ì§€ì—°
- ë©”ëª¨ë¦¬ ì˜¤ë²„í—¤ë“œ
- ë²ˆë“¤ ìµœì í™” ë¶ˆê°€

**í•´ê²°ì±…:** ì •ì  importë¡œ ì „í™˜

---

#### C. ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´ (100+íšŒ ë°˜ë³µ)

```typescript
// ë§¤ APIë§ˆë‹¤ ë°˜ë³µ
try {
  // ë¡œì§
} catch (error) {
  console.error("Error:", error);
  return res.status(500).json({ error: "Internal server error" });
}
```

**ë¬¸ì œì :**
- Zod ì—ëŸ¬, DB ì—ëŸ¬ êµ¬ë¶„ ì—†ìŒ
- ë¡œê·¸ í˜•ì‹ ë¶ˆì¼ì¹˜
- ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ ë¶ˆì¼ì¹˜

**í•´ê²°ì±…:** `server/utils/error-handler.ts` í†µí•©

---

#### D. íŒŒì¼ ì—…ë¡œë“œ ì„¤ì • (5íšŒ ì¤‘ë³µ)

```typescript
// uploads, banners, milestones, thumbnails, temp ê°ê° ì •ì˜
const storage = multer.diskStorage({
  destination: function (req, file, cb) { /* ì¤‘ë³µ ë¡œì§ */ },
  filename: function (req, file, cb) { /* ì¤‘ë³µ ë¡œì§ */ },
});
```

**í•´ê²°ì±…:** `server/config/upload-config.ts` íŒ©í† ë¦¬ íŒ¨í„´

---

### 2.3 í•˜ë“œì½”ë”© ìœ„ì¹˜ ë§¤í•‘

| íƒ€ì… | ìœ„ì¹˜ | ê°’ | ë¹ˆë„ |
|------|------|-----|------|
| **ê²½ë¡œ** | routes.ts:160-175 | `"uploads"`, `"static/banner"` | 9ê³³ |
| **íŒŒì¼ í¬ê¸°** | ì—¬ëŸ¬ ê³³ | `10 * 1024 * 1024` | 5ê³³ |
| **MIME íƒ€ì…** | ì—¬ëŸ¬ ê³³ | `['image/jpeg', ...]` | 3ê³³ |
| **ì‚¬ìš©ì ì—­í• ** | routes.ts:ì „ì—­ | `'admin'`, `'superadmin'` | 20+ê³³ |
| **ìƒíƒœê°’** | ì—¬ëŸ¬ ê³³ | `'pending'`, `'approved'` | 15+ê³³ |

**í•´ê²°ì±…:** `server/config/constants.ts` ìƒìˆ˜í™”

---

### 2.4 DB ì¿¼ë¦¬ íŒ¨í„´ ë¶„ì„

#### ë¬¸ì œ 1: N+1 ì¿¼ë¦¬
```typescript
// âŒ Bad
const milestones = await db.query.milestones.findMany();
for (const m of milestones) {
  const apps = await db.query.milestoneApplications.findMany({
    where: eq(milestoneApplications.milestoneId, m.id)
  });
}
```

#### ë¬¸ì œ 2: ì¤‘ë³µ ì¿¼ë¦¬
```typescript
// âŒ ë™ì¼í•œ ì¿¼ë¦¬ê°€ 20+ ê³³ì— ë°˜ë³µ
const user = await db.query.users.findFirst({
  where: eq(users.id, userId)
});
```

**í•´ê²°ì±…:** DB ì„œë¹„ìŠ¤ ë ˆì´ì–´ ìƒì„±

---

### 2.5 ë¡œê¹… ë¶„ì„

**í˜„í™©:**
```typescript
console.log: 412ê°œ
console.error: 220ê°œ
ì´: 632ê°œ
```

**ë¬¸ì œì :**
- í”„ë¡œë•ì…˜ í™˜ê²½ì— ë…¸ì¶œ
- ë¡œê·¸ ë ˆë²¨ êµ¬ë¶„ ì—†ìŒ
- êµ¬ì¡°í™”ë˜ì§€ ì•ŠìŒ (ê²€ìƒ‰ ë¶ˆê°€)
- ë¯¼ê° ì •ë³´ ë…¸ì¶œ ìœ„í—˜

**í•´ê²°ì±…:** winston ê¸°ë°˜ êµ¬ì¡°í™” ë¡œê¹…

---

## 3. ëª©í‘œ êµ¬ì¡° (To-Be)

### 3.1 ì™„ì„±ëœ íŒŒì¼ íŠ¸ë¦¬

```
server/
â”œâ”€â”€ routes.ts                     [150ì¤„] ë©”ì¸ ë¼ìš°í„° ë“±ë¡
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ constants.ts              [100ì¤„] ëª¨ë“  ìƒìˆ˜
â”‚   â”œâ”€â”€ upload-config.ts          [80ì¤„] íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
â”‚   â””â”€â”€ database.ts               [50ì¤„] DB ì—°ê²° ì„¤ì •
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ request-helpers.ts        [120ì¤„] ìš”ì²­ ì²˜ë¦¬ ìœ í‹¸
â”‚   â”œâ”€â”€ response-helpers.ts       [80ì¤„] ì‘ë‹µ í¬ë§·
â”‚   â”œâ”€â”€ error-handler.ts          [150ì¤„] ì—ëŸ¬ í•¸ë“¤ë§
â”‚   â””â”€â”€ logger.ts                 [100ì¤„] êµ¬ì¡°í™” ë¡œê¹…
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ user-service.ts       [200ì¤„] ì‚¬ìš©ì DB
â”‚   â”‚   â”œâ”€â”€ milestone-service.ts  [250ì¤„] ë§ˆì¼ìŠ¤í†¤ DB
â”‚   â”‚   â”œâ”€â”€ hospital-service.ts   [180ì¤„] ë³‘ì› DB
â”‚   â”‚   â””â”€â”€ image-service.ts      [150ì¤„] ì´ë¯¸ì§€ DB
â”‚   â”œâ”€â”€ milestones.ts             [ê¸°ì¡´ - ìµœì í™”]
â”‚   â”œâ”€â”€ openai.ts
â”‚   â”œâ”€â”€ gemini.ts
â”‚   â””â”€â”€ topmedia-service.ts
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.ts                   [ê°œì„ ]
â”‚   â”œâ”€â”€ admin-auth.ts             [ê°œì„ ]
â”‚   â”œâ”€â”€ permission.ts
â”‚   â”œâ”€â”€ error-handler.ts          [ê°œì„ ]
â”‚   â””â”€â”€ validation.ts             [ì‹ ê·œ] Zod ê²€ì¦
â””â”€â”€ routes/
    â”œâ”€â”€ auth-routes.ts            [350ì¤„] 12ê°œ API
    â”œâ”€â”€ user-routes.ts            [250ì¤„] 8ê°œ API
    â”œâ”€â”€ milestone-routes.ts       [500ì¤„] 18ê°œ API
    â”œâ”€â”€ image-routes.ts           [450ì¤„] 18ê°œ API
    â”œâ”€â”€ music-routes.ts           [280ì¤„] 8ê°œ API
    â”œâ”€â”€ chat-routes.ts            [220ì¤„] 6ê°œ API
    â”œâ”€â”€ gallery-routes.ts         [180ì¤„] 4ê°œ API
    â”œâ”€â”€ hospital-routes.ts        [400ì¤„] 13ê°œ API
    â”œâ”€â”€ qr-routes.ts              [220ì¤„] 6ê°œ API
    â”œâ”€â”€ concept-routes.ts         [350ì¤„] 12ê°œ API
    â”œâ”€â”€ service-routes.ts         [280ì¤„] 8ê°œ API
    â”œâ”€â”€ banner-routes.ts          [250ì¤„] 6ê°œ API
    â”œâ”€â”€ persona-routes.ts         [260ì¤„] 7ê°œ API
    â”œâ”€â”€ abtest-routes.ts          [240ì¤„] 6ê°œ API
    â”œâ”€â”€ admin-routes.ts           [600ì¤„] 25ê°œ API
    â””â”€â”€ utility-routes.ts         [300ì¤„] 9ê°œ API
```

**ì´ ë¼ì¸ ìˆ˜:** ~6,500ì¤„ (ë¶„ì‚°)  
**routes.ts:** 9,293ì¤„ â†’ 150ì¤„ (-98.4%)

---

### 3.2 ì˜ì¡´ì„± ê·¸ë˜í”„

```
routes.ts (ë©”ì¸)
â”œâ”€â†’ routes/auth-routes.ts
â”‚   â”œâ”€â†’ middleware/auth.ts
â”‚   â”œâ”€â†’ services/database/user-service.ts
â”‚   â””â”€â†’ utils/error-handler.ts
â”œâ”€â†’ routes/milestone-routes.ts
â”‚   â”œâ”€â†’ middleware/auth.ts
â”‚   â”œâ”€â†’ services/database/milestone-service.ts
â”‚   â”œâ”€â†’ services/milestones.ts
â”‚   â””â”€â†’ utils/error-handler.ts
â”œâ”€â†’ routes/hospital-routes.ts
â”‚   â”œâ”€â†’ middleware/admin-auth.ts
â”‚   â”œâ”€â†’ services/database/hospital-service.ts
â”‚   â””â”€â†’ config/upload-config.ts
â””â”€â†’ ... (ë‚˜ë¨¸ì§€ ë¼ìš°í„°)

ê³µí†µ ì˜ì¡´ì„±:
â”œâ”€â†’ utils/logger.ts (ëª¨ë“  ë¼ìš°í„°)
â”œâ”€â†’ config/constants.ts (ëª¨ë“  ë¼ìš°í„°)
â””â”€â†’ utils/request-helpers.ts (ì¸ì¦ í•„ìš” ë¼ìš°í„°)
```

---

## 4. Phase 1: ê¸°ë°˜ êµ¬ì¶•

### 4.1 ë””ë ‰í† ë¦¬ ìƒì„±

**ì‹¤í–‰ ëª…ë ¹:**
```bash
mkdir -p server/config
mkdir -p server/utils
mkdir -p server/services/database
mkdir -p server/routes
mkdir -p docs
```

---

### 4.2 constants.ts ì „ì²´ ì½”ë“œ

**íŒŒì¼:** `server/config/constants.ts`

```typescript
import path from 'path';

/**
 * íŒŒì¼ ê²½ë¡œ ìƒìˆ˜
 * - ëª¨ë“  íŒŒì¼ ì €ì¥ ê²½ë¡œë¥¼ ì¤‘ì•™ ê´€ë¦¬
 * - í™˜ê²½ì— ë”°ë¼ ë™ì  ë³€ê²½ ê°€ëŠ¥
 */
export const PATHS = {
  UPLOADS: path.join(process.cwd(), 'uploads'),
  STATIC: path.join(process.cwd(), 'static'),
  STATIC_BANNER: path.join(process.cwd(), 'static', 'banner'),
  STATIC_BANNER_SLIDE: path.join(process.cwd(), 'static', 'banner', 'slide-banners'),
  STATIC_BANNER_SMALL: path.join(process.cwd(), 'static', 'banner', 'small-banners'),
  STATIC_MILESTONE: path.join(process.cwd(), 'static', 'milestones'),
  THUMBNAILS: path.join(process.cwd(), 'uploads', 'thumbnails'),
  TEMP: path.join(process.cwd(), 'uploads', 'temp'),
} as const;

/**
 * íŒŒì¼ ì—…ë¡œë“œ ì œí•œ
 */
export const FILE_LIMITS = {
  MAX_IMAGE_SIZE: 10 * 1024 * 1024,      // 10MB
  MAX_AUDIO_SIZE: 50 * 1024 * 1024,      // 50MB
  MAX_VIDEO_SIZE: 100 * 1024 * 1024,     // 100MB
  MAX_DOCUMENT_SIZE: 5 * 1024 * 1024,    // 5MB
} as const;

/**
 * í—ˆìš© íŒŒì¼ íƒ€ì…
 */
export const ALLOWED_MIME_TYPES = {
  IMAGES: [
    'image/jpeg',
    'image/jpg',
    'image/png',
    'image/webp',
    'image/gif',
  ],
  AUDIO: [
    'audio/mpeg',
    'audio/mp3',
    'audio/wav',
    'audio/ogg',
  ],
  VIDEO: [
    'video/mp4',
    'video/webm',
    'video/ogg',
  ],
} as const;

/**
 * ì‚¬ìš©ì ì—­í•  ë° ê¶Œí•œ
 */
export const USER_ROLES = {
  FREE: 'free',
  PRO: 'pro',
  MEMBERSHIP: 'membership',
  HOSPITAL_ADMIN: 'hospital_admin',
  ADMIN: 'admin',
  SUPERADMIN: 'superadmin',
} as const;

export const ADMIN_ROLES = [
  USER_ROLES.ADMIN,
  USER_ROLES.SUPERADMIN,
] as const;

export const HOSPITAL_ADMIN_ROLES = [
  USER_ROLES.HOSPITAL_ADMIN,
  USER_ROLES.ADMIN,
  USER_ROLES.SUPERADMIN,
] as const;

/**
 * ë§ˆì¼ìŠ¤í†¤ ìƒíƒœ
 */
export const MILESTONE_STATUS = {
  ACTIVE: 'active',
  INACTIVE: 'inactive',
  COMPLETED: 'completed',
  EXPIRED: 'expired',
} as const;

/**
 * ì‹ ì²­ ìƒíƒœ
 */
export const APPLICATION_STATUS = {
  PENDING: 'pending',
  APPROVED: 'approved',
  REJECTED: 'rejected',
  CANCELLED: 'cancelled',
  EXPIRED: 'expired',
} as const;

/**
 * ì´ë¯¸ì§€ ì¹´í…Œê³ ë¦¬
 */
export const IMAGE_CATEGORIES = {
  MATERNITY: 'mansak_img',      // ë§Œì‚­ ì‚¬ì§„
  FAMILY: 'family_img',          // ê°€ì¡± ì‚¬ì§„
  STICKER: 'sticker_img',        // ìŠ¤í‹°ì»¤
} as const;

/**
 * ìŒì•… ìŠ¤íƒ€ì¼ (TopMediai)
 */
export const MUSIC_STYLES = {
  POP: 'pop',
  BALLAD: 'ballad',
  ACOUSTIC: 'acoustic',
  LULLABY: 'lullaby',
  CLASSICAL: 'classical',
} as const;

/**
 * AI ëª¨ë¸ ì œê³µì
 */
export const AI_PROVIDERS = {
  OPENAI: 'openai',
  GEMINI: 'gemini',
  TOPMEDIA: 'topmedia',
} as const;

/**
 * í˜ì´ì§€ë„¤ì´ì…˜ ê¸°ë³¸ê°’
 */
export const PAGINATION = {
  DEFAULT_PAGE: 1,
  DEFAULT_LIMIT: 20,
  MAX_LIMIT: 100,
} as const;

/**
 * Rate Limiting (ìš”ì²­ ì œí•œ)
 */
export const RATE_LIMITS = {
  API_GENERAL: {
    windowMs: 15 * 60 * 1000,  // 15ë¶„
    max: 100,                   // ìµœëŒ€ 100 ìš”ì²­
  },
  API_AUTH: {
    windowMs: 15 * 60 * 1000,
    max: 5,                     // ë¡œê·¸ì¸ ì‹œë„ 5íšŒ
  },
  API_UPLOAD: {
    windowMs: 60 * 60 * 1000,  // 1ì‹œê°„
    max: 20,                    // ì—…ë¡œë“œ 20íšŒ
  },
  API_AI_GENERATION: {
    windowMs: 60 * 60 * 1000,
    max: 10,                    // AI ìƒì„± 10íšŒ
  },
} as const;

/**
 * ì„¸ì…˜ ì„¤ì •
 */
export const SESSION_CONFIG = {
  SECRET: process.env.SESSION_SECRET || 'your-secret-key-change-in-production',
  MAX_AGE: 7 * 24 * 60 * 60 * 1000,  // 7ì¼
  COOKIE_NAME: 'chango_ai_session',
} as const;

/**
 * JWT ì„¤ì •
 */
export const JWT_CONFIG = {
  SECRET: process.env.JWT_SECRET || 'your-jwt-secret-change-in-production',
  EXPIRES_IN: '7d',
  REFRESH_EXPIRES_IN: '30d',
} as const;

/**
 * ì—ëŸ¬ ë©”ì‹œì§€
 */
export const ERROR_MESSAGES = {
  UNAUTHORIZED: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤',
  FORBIDDEN: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤',
  NOT_FOUND: 'ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
  VALIDATION_FAILED: 'ì…ë ¥ê°’ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
  INTERNAL_SERVER_ERROR: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
  INVALID_FILE_TYPE: 'ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤',
  FILE_TOO_LARGE: 'íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤',
  RATE_LIMIT_EXCEEDED: 'ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤',
} as const;

/**
 * ì„±ê³µ ë©”ì‹œì§€
 */
export const SUCCESS_MESSAGES = {
  CREATED: 'ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
  UPDATED: 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤',
  DELETED: 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤',
  UPLOADED: 'ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤',
} as const;

/**
 * íƒ€ì… í—¬í¼
 */
export type UserRole = typeof USER_ROLES[keyof typeof USER_ROLES];
export type MilestoneStatus = typeof MILESTONE_STATUS[keyof typeof MILESTONE_STATUS];
export type ApplicationStatus = typeof APPLICATION_STATUS[keyof typeof APPLICATION_STATUS];
export type ImageCategory = typeof IMAGE_CATEGORIES[keyof typeof IMAGE_CATEGORIES];
```

---

### 4.3 request-helpers.ts ì „ì²´ ì½”ë“œ

**íŒŒì¼:** `server/utils/request-helpers.ts`

```typescript
import type { Request, Response } from 'express';
import { USER_ROLES, ADMIN_ROLES } from '../config/constants';

/**
 * ìš”ì²­ì—ì„œ ì‚¬ìš©ì ID ì¶”ì¶œ
 * - req.user.id, req.user.userId, req.user.sub ëª¨ë‘ ì§€ì›
 * - Number íƒ€ì…ìœ¼ë¡œ ì •ê·œí™”
 */
export function extractUserId(req: Request): number {
  const userIdRaw = req.user?.userId || req.user?.id || req.user?.sub;
  const userId = Number(userIdRaw);
  
  if (isNaN(userId)) {
    throw new Error('Invalid user ID');
  }
  
  return userId;
}

/**
 * ì‚¬ìš©ì ID ê²€ì¦ ë° ì¶”ì¶œ
 * - ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ 401 ì‘ë‹µ
 * - ì„±ê³µ ì‹œ userId ë°˜í™˜, ì‹¤íŒ¨ ì‹œ null
 */
export function validateAuthUser(req: Request, res: Response): number | null {
  try {
    const userId = extractUserId(req);
    return userId;
  } catch (error) {
    res.status(401).json({
      success: false,
      error: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤',
    });
    return null;
  }
}

/**
 * ì‚¬ìš©ì IDë¥¼ Stringìœ¼ë¡œ ì¶”ì¶œ (ì¼ë¶€ ë ˆê±°ì‹œ APIìš©)
 */
export function extractUserIdString(req: Request): string {
  const userId = req.user?.userId || req.user?.id || req.user?.sub;
  return String(userId);
}

/**
 * ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
 */
export function isAdmin(req: Request): boolean {
  const memberType = req.user?.memberType || req.user?.userRole;
  return ADMIN_ROLES.includes(memberType as any);
}

/**
 * ë³‘ì› ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
 */
export function isHospitalAdmin(req: Request): boolean {
  const memberType = req.user?.memberType || req.user?.userRole;
  return [
    USER_ROLES.HOSPITAL_ADMIN,
    USER_ROLES.ADMIN,
    USER_ROLES.SUPERADMIN,
  ].includes(memberType as any);
}

/**
 * ìŠˆí¼ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
 */
export function isSuperAdmin(req: Request): boolean {
  const memberType = req.user?.memberType || req.user?.userRole;
  return memberType === USER_ROLES.SUPERADMIN;
}

/**
 * ë³‘ì› ID ì¶”ì¶œ
 */
export function extractHospitalId(req: Request): number | undefined {
  const hospitalId = req.user?.hospitalId;
  return hospitalId ? Number(hospitalId) : undefined;
}

/**
 * í˜ì´ì§€ë„¤ì´ì…˜ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
 */
export interface PaginationParams {
  page: number;
  limit: number;
  offset: number;
}

export function extractPagination(req: Request, defaultLimit = 20): PaginationParams {
  const page = Math.max(1, Number(req.query.page) || 1);
  const limit = Math.min(100, Math.max(1, Number(req.query.limit) || defaultLimit));
  const offset = (page - 1) * limit;
  
  return { page, limit, offset };
}

/**
 * ì •ë ¬ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
 */
export interface SortParams {
  sortBy: string;
  sortOrder: 'asc' | 'desc';
}

export function extractSort(
  req: Request,
  allowedFields: string[] = [],
  defaultSortBy = 'createdAt'
): SortParams {
  const sortBy = req.query.sortBy as string || defaultSortBy;
  const sortOrder = (req.query.sortOrder as string)?.toLowerCase() === 'asc' ? 'asc' : 'desc';
  
  // í—ˆìš©ëœ í•„ë“œë§Œ ì •ë ¬ ê°€ëŠ¥
  const validSortBy = allowedFields.length > 0 && !allowedFields.includes(sortBy)
    ? defaultSortBy
    : sortBy;
  
  return { sortBy: validSortBy, sortOrder };
}

/**
 * í•„í„° íŒŒë¼ë¯¸í„° ì¶”ì¶œ (íƒ€ì… ì•ˆì „)
 */
export function extractFilters<T extends Record<string, any>>(
  req: Request,
  allowedFilters: (keyof T)[]
): Partial<T> {
  const filters: Partial<T> = {};
  
  for (const key of allowedFilters) {
    const value = req.query[key as string];
    if (value !== undefined && value !== null && value !== '') {
      filters[key] = value as T[keyof T];
    }
  }
  
  return filters;
}

/**
 * ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ì—ì„œ boolean ê°’ ì¶”ì¶œ
 */
export function extractBoolean(value: any): boolean | undefined {
  if (value === undefined || value === null) return undefined;
  if (value === 'true' || value === '1' || value === 1) return true;
  if (value === 'false' || value === '0' || value === 0) return false;
  return undefined;
}

/**
 * ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ì—ì„œ ìˆ«ì ë°°ì—´ ì¶”ì¶œ
 */
export function extractNumberArray(value: any): number[] {
  if (!value) return [];
  
  const arr = Array.isArray(value) ? value : [value];
  return arr.map(v => Number(v)).filter(v => !isNaN(v));
}

/**
 * ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ì—ì„œ ë¬¸ìì—´ ë°°ì—´ ì¶”ì¶œ
 */
export function extractStringArray(value: any): string[] {
  if (!value) return [];
  
  const arr = Array.isArray(value) ? value : [value];
  return arr.map(v => String(v)).filter(v => v.length > 0);
}
```

---

### 4.4 error-handler.ts ì „ì²´ ì½”ë“œ

**íŒŒì¼:** `server/utils/error-handler.ts`

```typescript
import type { Request, Response, NextFunction } from 'express';
import { ZodError } from 'zod';
import { logger } from './logger';

/**
 * ì»¤ìŠ¤í…€ ì—ëŸ¬ í´ë˜ìŠ¤
 */
export class AppError extends Error {
  constructor(
    public statusCode: number,
    public message: string,
    public isOperational = true,
    public details?: any
  ) {
    super(message);
    Object.setPrototypeOf(this, AppError.prototype);
    Error.captureStackTrace(this, this.constructor);
  }
}

/**
 * ì—ëŸ¬ í•¸ë“¤ëŸ¬ (Express ë¯¸ë“¤ì›¨ì–´)
 */
export function errorHandler(
  error: Error | AppError | ZodError,
  req: Request,
  res: Response,
  next: NextFunction
) {
  // ì´ë¯¸ ì‘ë‹µì´ ì‹œì‘ëœ ê²½ìš°
  if (res.headersSent) {
    return next(error);
  }

  // Zod ê²€ì¦ ì—ëŸ¬
  if (error instanceof ZodError) {
    logger.warn('Validation error', {
      path: req.path,
      errors: error.errors,
    });
    
    return res.status(400).json({
      success: false,
      error: 'ì…ë ¥ê°’ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
      details: error.errors.map(e => ({
        field: e.path.join('.'),
        message: e.message,
      })),
    });
  }

  // ì»¤ìŠ¤í…€ AppError
  if (error instanceof AppError) {
    logger.error('Application error', {
      statusCode: error.statusCode,
      message: error.message,
      path: req.path,
      details: error.details,
    });
    
    return res.status(error.statusCode).json({
      success: false,
      error: error.message,
      ...(error.details && { details: error.details }),
    });
  }

  // ê¸°íƒ€ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬
  logger.error('Unexpected error', {
    error: error.message,
    stack: error.stack,
    path: req.path,
  });
  
  return res.status(500).json({
    success: false,
    error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
    ...(process.env.NODE_ENV === 'development' && {
      details: {
        message: error.message,
        stack: error.stack,
      },
    }),
  });
}

/**
 * 404 í•¸ë“¤ëŸ¬
 */
export function notFoundHandler(req: Request, res: Response) {
  logger.warn('Route not found', { path: req.path });
  
  res.status(404).json({
    success: false,
    error: 'ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
    path: req.path,
  });
}

/**
 * ì—ëŸ¬ ë˜í¼ í—¬í¼ (try-catch ì œê±°)
 */
export function asyncHandler(
  fn: (req: Request, res: Response, next: NextFunction) => Promise<any>
) {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
}

/**
 * ì—ëŸ¬ ì²˜ë¦¬ í—¬í¼ (ë¼ìš°í„° ë‚´ë¶€ìš©)
 */
export function handleError(error: unknown, res: Response, context?: string): void {
  if (res.headersSent) {
    return;
  }

  logger.error(`Error in ${context || 'unknown context'}`, { error });

  if (error instanceof ZodError) {
    res.status(400).json({
      success: false,
      error: 'ì…ë ¥ê°’ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
      details: error.errors,
    });
    return;
  }

  if (error instanceof AppError) {
    res.status(error.statusCode).json({
      success: false,
      error: error.message,
      ...(error.details && { details: error.details }),
    });
    return;
  }

  res.status(500).json({
    success: false,
    error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
  });
}

/**
 * íŠ¹ì • ìƒí™©ë³„ ì—ëŸ¬ ìƒì„± í—¬í¼
 */
export const createError = {
  unauthorized: (message = 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤') => 
    new AppError(401, message),
  
  forbidden: (message = 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤') => 
    new AppError(403, message),
  
  notFound: (message = 'ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤') => 
    new AppError(404, message),
  
  badRequest: (message = 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤', details?: any) => 
    new AppError(400, message, true, details),
  
  conflict: (message = 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤') => 
    new AppError(409, message),
  
  tooManyRequests: (message = 'ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤') => 
    new AppError(429, message),
  
  internal: (message = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤') => 
    new AppError(500, message, false),
};
```

---

### 4.5 logger.ts ì „ì²´ ì½”ë“œ

**íŒŒì¼:** `server/utils/logger.ts`

```typescript
import winston from 'winston';
import path from 'path';
import fs from 'fs';

// ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
const logDir = path.join(process.cwd(), 'logs');
if (!fs.existsSync(logDir)) {
  fs.mkdirSync(logDir, { recursive: true });
}

/**
 * ë¡œê·¸ ë ˆë²¨
 * error: 0, warn: 1, info: 2, http: 3, verbose: 4, debug: 5, silly: 6
 */
const levels = {
  error: 0,
  warn: 1,
  info: 2,
  http: 3,
  debug: 4,
};

/**
 * í™˜ê²½ì— ë”°ë¥¸ ë¡œê·¸ ë ˆë²¨
 */
const level = () => {
  const env = process.env.NODE_ENV || 'development';
  const isDevelopment = env === 'development';
  return isDevelopment ? 'debug' : 'info';
};

/**
 * ë¡œê·¸ ìƒ‰ìƒ
 */
const colors = {
  error: 'red',
  warn: 'yellow',
  info: 'green',
  http: 'magenta',
  debug: 'blue',
};

winston.addColors(colors);

/**
 * ë¡œê·¸ í¬ë§·
 */
const format = winston.format.combine(
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.errors({ stack: true }),
  winston.format.splat(),
  winston.format.json()
);

/**
 * ì½˜ì†” ì¶œë ¥ í¬ë§· (ê°œë°œ í™˜ê²½)
 */
const consoleFormat = winston.format.combine(
  winston.format.colorize({ all: true }),
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.printf(
    (info) => `${info.timestamp} ${info.level}: ${info.message}${
      info.stack ? `\n${info.stack}` : ''
    }`
  )
);

/**
 * Transports (ë¡œê·¸ ì¶œë ¥ ëŒ€ìƒ)
 */
const transports = [
  // ì—ëŸ¬ ë¡œê·¸ (error.log)
  new winston.transports.File({
    filename: path.join(logDir, 'error.log'),
    level: 'error',
    maxsize: 5242880, // 5MB
    maxFiles: 5,
  }),
  
  // ì „ì²´ ë¡œê·¸ (combined.log)
  new winston.transports.File({
    filename: path.join(logDir, 'combined.log'),
    maxsize: 5242880, // 5MB
    maxFiles: 5,
  }),
  
  // HTTP ë¡œê·¸ (http.log)
  new winston.transports.File({
    filename: path.join(logDir, 'http.log'),
    level: 'http',
    maxsize: 5242880,
    maxFiles: 3,
  }),
];

// ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì½˜ì†” ì¶œë ¥ ì¶”ê°€
if (process.env.NODE_ENV !== 'production') {
  transports.push(
    new winston.transports.Console({
      format: consoleFormat,
    })
  );
}

/**
 * Winston Logger ì¸ìŠ¤í„´ìŠ¤
 */
export const logger = winston.createLogger({
  level: level(),
  levels,
  format,
  transports,
  exitOnError: false,
});

/**
 * ìŠ¤íŠ¸ë¦¼ (Morgan ì—°ë™ìš©)
 */
export const stream = {
  write: (message: string) => {
    logger.http(message.trim());
  },
};

/**
 * í—¬í¼ í•¨ìˆ˜ë“¤
 */

// ì‚¬ìš©ì ì•¡ì…˜ ë¡œê¹…
export function logUserAction(userId: number, action: string, details?: any) {
  logger.info('User action', {
    userId,
    action,
    ...details,
  });
}

// API ìš”ì²­ ë¡œê¹…
export function logApiRequest(
  method: string,
  path: string,
  userId?: number,
  statusCode?: number,
  duration?: number
) {
  logger.http('API request', {
    method,
    path,
    userId,
    statusCode,
    duration,
  });
}

// DB ì¿¼ë¦¬ ë¡œê¹… (ê°œë°œ í™˜ê²½)
export function logDbQuery(query: string, duration?: number) {
  if (process.env.NODE_ENV === 'development') {
    logger.debug('DB query', {
      query: query.substring(0, 200),
      duration,
    });
  }
}

// ì™¸ë¶€ API í˜¸ì¶œ ë¡œê¹…
export function logExternalApi(
  service: string,
  endpoint: string,
  method: string,
  statusCode?: number,
  duration?: number
) {
  logger.info('External API call', {
    service,
    endpoint,
    method,
    statusCode,
    duration,
  });
}

// íŒŒì¼ ì—…ë¡œë“œ ë¡œê¹…
export function logFileUpload(
  userId: number,
  filename: string,
  size: number,
  mimetype: string
) {
  logger.info('File upload', {
    userId,
    filename,
    size,
    mimetype,
  });
}

// ì—ëŸ¬ ë¡œê¹… (ìƒì„¸)
export function logError(
  error: Error,
  context?: string,
  userId?: number,
  additionalInfo?: any
) {
  logger.error('Application error', {
    message: error.message,
    stack: error.stack,
    context,
    userId,
    ...additionalInfo,
  });
}

// ë³´ì•ˆ ì´ë²¤íŠ¸ ë¡œê¹…
export function logSecurityEvent(
  event: string,
  severity: 'low' | 'medium' | 'high' | 'critical',
  details?: any
) {
  logger.warn('Security event', {
    event,
    severity,
    ...details,
  });
}

/**
 * í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ console.log ëŒ€ì²´
 */
if (process.env.NODE_ENV === 'production') {
  console.log = (...args) => logger.info(args.join(' '));
  console.error = (...args) => logger.error(args.join(' '));
  console.warn = (...args) => logger.warn(args.join(' '));
  console.debug = (...args) => logger.debug(args.join(' '));
}
```

---

### 4.6 upload-config.ts ì „ì²´ ì½”ë“œ

**íŒŒì¼:** `server/config/upload-config.ts`

```typescript
import multer from 'multer';
import path from 'path';
import fs from 'fs';
import { PATHS, FILE_LIMITS, ALLOWED_MIME_TYPES } from './constants';
import { AppError } from '../utils/error-handler';
import { logger } from '../utils/logger';

/**
 * ì—…ë¡œë“œ ëŒ€ìƒ íƒ€ì…
 */
export type UploadDestination = 
  | 'uploads'
  | 'banners'
  | 'small-banners'
  | 'milestones'
  | 'thumbnails'
  | 'temp';

/**
 * íŒŒì¼ íƒ€ì…
 */
export type FileType = 'image' | 'audio' | 'video' | 'document';

/**
 * ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´ ìë™ ìƒì„±)
 */
function ensureDirectoryExists(dirPath: string): void {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
    logger.info(`Created directory: ${dirPath}`);
  }
}

/**
 * ëª¨ë“  ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ì´ˆê¸°í™”
 */
export function initializeUploadDirectories(): void {
  Object.values(PATHS).forEach(dirPath => {
    ensureDirectoryExists(dirPath);
  });
  logger.info('All upload directories initialized');
}

/**
 * íŒŒì¼ íƒ€ì…ì— ë”°ë¥¸ í¬ê¸° ì œí•œ
 */
function getFileSizeLimit(fileType: FileType): number {
  switch (fileType) {
    case 'image':
      return FILE_LIMITS.MAX_IMAGE_SIZE;
    case 'audio':
      return FILE_LIMITS.MAX_AUDIO_SIZE;
    case 'video':
      return FILE_LIMITS.MAX_VIDEO_SIZE;
    case 'document':
      return FILE_LIMITS.MAX_DOCUMENT_SIZE;
    default:
      return FILE_LIMITS.MAX_IMAGE_SIZE;
  }
}

/**
 * íŒŒì¼ íƒ€ì…ì— ë”°ë¥¸ í—ˆìš© MIME íƒ€ì…
 */
function getAllowedMimeTypes(fileType: FileType): string[] {
  switch (fileType) {
    case 'image':
      return ALLOWED_MIME_TYPES.IMAGES;
    case 'audio':
      return ALLOWED_MIME_TYPES.AUDIO;
    case 'video':
      return ALLOWED_MIME_TYPES.VIDEO;
    default:
      return ALLOWED_MIME_TYPES.IMAGES;
  }
}

/**
 * Multer ì—…ë¡œë“œ ë¯¸ë“¤ì›¨ì–´ ìƒì„± (íŒ©í† ë¦¬ íŒ¨í„´)
 */
export function createUploadMiddleware(
  destination: UploadDestination,
  fileType: FileType = 'image',
  options?: {
    maxFileSize?: number;
    allowedMimeTypes?: string[];
    fileFieldName?: string;
  }
) {
  // ëŒ€ìƒ ë””ë ‰í† ë¦¬ ê²°ì •
  const destinationPath = (() => {
    switch (destination) {
      case 'uploads':
        return PATHS.UPLOADS;
      case 'banners':
        return PATHS.STATIC_BANNER_SLIDE;
      case 'small-banners':
        return PATHS.STATIC_BANNER_SMALL;
      case 'milestones':
        return PATHS.STATIC_MILESTONE;
      case 'thumbnails':
        return PATHS.THUMBNAILS;
      case 'temp':
        return PATHS.TEMP;
      default:
        return PATHS.UPLOADS;
    }
  })();

  // ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
  ensureDirectoryExists(destinationPath);

  // Multer Storage ì„¤ì •
  const storage = multer.diskStorage({
    destination: (req, file, cb) => {
      cb(null, destinationPath);
    },
    filename: (req, file, cb) => {
      const uniqueSuffix = `${Date.now()}-${Math.round(Math.random() * 1e9)}`;
      const ext = path.extname(file.originalname);
      const basename = path.basename(file.originalname, ext);
      const sanitizedBasename = basename.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_');
      
      cb(null, `${destination}-${sanitizedBasename}-${uniqueSuffix}${ext}`);
    },
  });

  // íŒŒì¼ í•„í„° (MIME íƒ€ì… ê²€ì¦)
  const fileFilter = (req: any, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
    const allowedTypes = options?.allowedMimeTypes || getAllowedMimeTypes(fileType);
    
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new AppError(400, `ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. í—ˆìš©ëœ í˜•ì‹: ${allowedTypes.join(', ')}`));
    }
  };

  // Multer ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  return multer({
    storage,
    limits: {
      fileSize: options?.maxFileSize || getFileSizeLimit(fileType),
    },
    fileFilter,
  });
}

/**
 * ì‚¬ì „ ì •ì˜ëœ ì—…ë¡œë“œ ë¯¸ë“¤ì›¨ì–´
 */
export const uploadMiddlewares = {
  // ì¼ë°˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ
  image: createUploadMiddleware('uploads', 'image'),
  
  // ë°°ë„ˆ ì´ë¯¸ì§€ (ìŠ¬ë¼ì´ë“œ)
  banner: createUploadMiddleware('banners', 'image'),
  
  // ì‘ì€ ë°°ë„ˆ
  smallBanner: createUploadMiddleware('small-banners', 'image'),
  
  // ë§ˆì¼ìŠ¤í†¤ ì´ë¯¸ì§€
  milestone: createUploadMiddleware('milestones', 'image'),
  
  // ì¸ë„¤ì¼
  thumbnail: createUploadMiddleware('thumbnails', 'image', {
    maxFileSize: 2 * 1024 * 1024, // 2MB
  }),
  
  // ìŒì•… íŒŒì¼
  audio: createUploadMiddleware('uploads', 'audio'),
  
  // ì„ì‹œ íŒŒì¼
  temp: createUploadMiddleware('temp', 'image'),
};

/**
 * íŒŒì¼ ì‚­ì œ í—¬í¼
 */
export function deleteFile(filePath: string): Promise<void> {
  return new Promise((resolve, reject) => {
    fs.unlink(filePath, (err) => {
      if (err) {
        logger.error('Failed to delete file', { filePath, error: err });
        reject(err);
      } else {
        logger.info('File deleted', { filePath });
        resolve();
      }
    });
  });
}

/**
 * íŒŒì¼ ì´ë™ í—¬í¼
 */
export function moveFile(sourcePath: string, destPath: string): Promise<void> {
  return new Promise((resolve, reject) => {
    fs.rename(sourcePath, destPath, (err) => {
      if (err) {
        logger.error('Failed to move file', { sourcePath, destPath, error: err });
        reject(err);
      } else {
        logger.info('File moved', { sourcePath, destPath });
        resolve();
      }
    });
  });
}

/**
 * íŒŒì¼ ë³µì‚¬ í—¬í¼
 */
export function copyFile(sourcePath: string, destPath: string): Promise<void> {
  return new Promise((resolve, reject) => {
    fs.copyFile(sourcePath, destPath, (err) => {
      if (err) {
        logger.error('Failed to copy file', { sourcePath, destPath, error: err });
        reject(err);
      } else {
        logger.info('File copied', { sourcePath, destPath });
        resolve();
      }
    });
  });
}
```

---

### 4.7 database-service.ts ì „ì²´ ì½”ë“œ

**íŒŒì¼:** `server/services/database/user-service.ts`

```typescript
import { db } from '@db';
import { users, type User } from '@shared/schema';
import { eq, and, or, like, desc } from 'drizzle-orm';
import { logger } from '../../utils/logger';
import { createError } from '../../utils/error-handler';
import type { PaginationParams } from '../../utils/request-helpers';

/**
 * ì‚¬ìš©ì DB ì„œë¹„ìŠ¤
 * - ëª¨ë“  ì‚¬ìš©ì ê´€ë ¨ DB ì¿¼ë¦¬ë¥¼ ì¤‘ì•™ ê´€ë¦¬
 * - ì¿¼ë¦¬ ì¤‘ë³µ ì œê±°
 * - íŠ¸ëœì­ì…˜ ê´€ë¦¬
 */
export class UserService {
  /**
   * IDë¡œ ì‚¬ìš©ì ì¡°íšŒ
   */
  static async findById(userId: number) {
    const user = await db.query.users.findFirst({
      where: eq(users.id, userId),
    });
    
    if (!user) {
      throw createError.notFound('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    return user;
  }

  /**
   * ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ
   */
  static async findByEmail(email: string) {
    return db.query.users.findFirst({
      where: eq(users.email, email),
    });
  }

  /**
   * ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
   */
  static async exists(userId: number): Promise<boolean> {
    const user = await db.query.users.findFirst({
      where: eq(users.id, userId),
      columns: { id: true },
    });
    
    return !!user;
  }

  /**
   * ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
   */
  static async isAdmin(userId: number): Promise<boolean> {
    const user = await this.findById(userId);
    return ['admin', 'superadmin'].includes(user.memberType || '');
  }

  /**
   * ë³‘ì› ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
   */
  static async isHospitalAdmin(userId: number): Promise<boolean> {
    const user = await this.findById(userId);
    return ['hospital_admin', 'admin', 'superadmin'].includes(user.memberType || '');
  }

  /**
   * ìŠˆí¼ ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
   */
  static async isSuperAdmin(userId: number): Promise<boolean> {
    const user = await this.findById(userId);
    return user.memberType === 'superadmin';
  }

  /**
   * ì‚¬ìš©ì í”„ë¡œí•„ ì—…ë°ì´íŠ¸
   */
  static async updateProfile(
    userId: number,
    data: Partial<Omit<User, 'id' | 'createdAt'>>
  ) {
    const [updatedUser] = await db
      .update(users)
      .set({
        ...data,
        updatedAt: new Date(),
      })
      .where(eq(users.id, userId))
      .returning();
    
    if (!updatedUser) {
      throw createError.notFound('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    logger.info('User profile updated', { userId });
    return updatedUser;
  }

  /**
   * ë³‘ì› IDë¡œ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
   */
  static async findByHospitalId(hospitalId: number, pagination?: PaginationParams) {
    const query = db.query.users.findMany({
      where: eq(users.hospitalId, hospitalId),
      orderBy: desc(users.createdAt),
      ...(pagination && {
        limit: pagination.limit,
        offset: pagination.offset,
      }),
    });
    
    return query;
  }

  /**
   * ì‚¬ìš©ì ê²€ìƒ‰ (ì´ë¦„, ì´ë©”ì¼)
   */
  static async search(searchTerm: string, pagination?: PaginationParams) {
    const searchPattern = `%${searchTerm}%`;
    
    return db.query.users.findMany({
      where: or(
        like(users.name, searchPattern),
        like(users.email, searchPattern)
      ),
      orderBy: desc(users.createdAt),
      ...(pagination && {
        limit: pagination.limit,
        offset: pagination.offset,
      }),
    });
  }

  /**
   * ì‚¬ìš©ì ì‚­ì œ (soft delete)
   */
  static async softDelete(userId: number) {
    const [deletedUser] = await db
      .update(users)
      .set({
        deletedAt: new Date(),
        updatedAt: new Date(),
      })
      .where(eq(users.id, userId))
      .returning();
    
    if (!deletedUser) {
      throw createError.notFound('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    logger.info('User soft deleted', { userId });
    return deletedUser;
  }

  /**
   * ì‚¬ìš©ì í†µê³„
   */
  static async getStats(hospitalId?: number) {
    // TODO: ì§‘ê³„ ì¿¼ë¦¬ êµ¬í˜„
    // ì´ ì‚¬ìš©ì ìˆ˜, ë©¤ë²„ì‹­ íƒ€ì…ë³„ ë¶„í¬ ë“±
    return {
      total: 0,
      byMemberType: {},
    };
  }
}
```

---

**íŒŒì¼:** `server/services/database/milestone-service.ts`

```typescript
import { db } from '@db';
import { milestones, milestoneApplications } from '@shared/schema';
import { eq, and, desc, gte, lte, isNull, or } from 'drizzle-orm';
import { logger } from '../../utils/logger';
import { createError } from '../../utils/error-handler';

/**
 * ë§ˆì¼ìŠ¤í†¤ DB ì„œë¹„ìŠ¤
 * - services/milestones.tsì˜ DB ì¿¼ë¦¬ë¥¼ ì—¬ê¸°ì„œ ê´€ë¦¬
 * - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ services/milestones.tsì— ìœ ì§€
 */
export class MilestoneService {
  /**
   * ëª¨ë“  ë§ˆì¼ìŠ¤í†¤ ì¡°íšŒ (í•„í„°ë§ í¬í•¨)
   */
  static async findAll(filters?: {
    type?: string;
    hospitalId?: number;
    isActive?: boolean;
  }) {
    const conditions = [];
    
    if (filters?.type) {
      conditions.push(eq(milestones.type, filters.type));
    }
    
    if (filters?.hospitalId !== undefined) {
      if (filters.hospitalId === null) {
        conditions.push(isNull(milestones.hospitalId));
      } else {
        conditions.push(eq(milestones.hospitalId, filters.hospitalId));
      }
    }
    
    if (filters?.isActive) {
      const now = new Date();
      conditions.push(
        or(
          isNull(milestones.startDate),
          lte(milestones.startDate, now)
        ),
        or(
          isNull(milestones.endDate),
          gte(milestones.endDate, now)
        )
      );
    }
    
    return db.query.milestones.findMany({
      where: conditions.length > 0 ? and(...conditions) : undefined,
      orderBy: desc(milestones.createdAt),
    });
  }

  /**
   * IDë¡œ ë§ˆì¼ìŠ¤í†¤ ì¡°íšŒ
   */
  static async findById(milestoneId: number) {
    const milestone = await db.query.milestones.findFirst({
      where: eq(milestones.id, milestoneId),
    });
    
    if (!milestone) {
      throw createError.notFound('ë§ˆì¼ìŠ¤í†¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    return milestone;
  }

  /**
   * ì‚¬ìš©ìì˜ ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ
   */
  static async findUserApplications(userId: number) {
    return db.query.milestoneApplications.findMany({
      where: eq(milestoneApplications.userId, userId),
      with: {
        milestone: true,
      },
      orderBy: desc(milestoneApplications.createdAt),
    });
  }

  /**
   * ë§ˆì¼ìŠ¤í†¤ ì‹ ì²­
   */
  static async applyToMilestone(
    userId: number,
    milestoneId: number,
    data: any
  ) {
    // ì¤‘ë³µ ì‹ ì²­ í™•ì¸
    const existing = await db.query.milestoneApplications.findFirst({
      where: and(
        eq(milestoneApplications.userId, userId),
        eq(milestoneApplications.milestoneId, milestoneId)
      ),
    });
    
    if (existing) {
      throw createError.conflict('ì´ë¯¸ ì‹ ì²­í•œ ë§ˆì¼ìŠ¤í†¤ì…ë‹ˆë‹¤');
    }
    
    const [application] = await db
      .insert(milestoneApplications)
      .values({
        userId,
        milestoneId,
        status: 'pending',
        ...data,
      })
      .returning();
    
    logger.info('Milestone application created', { userId, milestoneId });
    return application;
  }

  /**
   * ì‹ ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
   */
  static async updateApplicationStatus(
    applicationId: number,
    status: string
  ) {
    const [updated] = await db
      .update(milestoneApplications)
      .set({
        status,
        updatedAt: new Date(),
      })
      .where(eq(milestoneApplications.id, applicationId))
      .returning();
    
    if (!updated) {
      throw createError.notFound('ì‹ ì²­ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    logger.info('Application status updated', { applicationId, status });
    return updated;
  }
}
```

---

### 4.8 Phase 1 ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

```
Phase 1 ì™„ë£Œ í›„ í™•ì¸ ì‚¬í•­:

â–¡ ëª¨ë“  íŒŒì¼ ìƒì„± ì™„ë£Œ
  â–¡ server/config/constants.ts
  â–¡ server/utils/request-helpers.ts
  â–¡ server/utils/error-handler.ts
  â–¡ server/utils/logger.ts
  â–¡ server/config/upload-config.ts
  â–¡ server/services/database/user-service.ts
  â–¡ server/services/database/milestone-service.ts

â–¡ ì»´íŒŒì¼ ì—ëŸ¬ ì—†ìŒ
  â–¡ TypeScript íƒ€ì… ì²´í¬ í†µê³¼
  â–¡ import ê²½ë¡œ ì •ìƒ

â–¡ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
  â–¡ constants ì„í¬íŠ¸ ê°€ëŠ¥
  â–¡ logger ë™ì‘ í™•ì¸
  â–¡ error-handler ë™ì‘ í™•ì¸

â–¡ ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„± í™•ì¸
  â–¡ logs/ í´ë” ìƒì„±ë¨
  â–¡ ë¡œê·¸ íŒŒì¼ ì“°ê¸° ê°€ëŠ¥
```

---

## 5. Phase 2: ë¼ìš°í„° ëŒ€ë¶„ë¦¬

### 5.1 ë¶„ë¦¬ ì „ëµ

**ì›ì¹™:**
1. **í•œ íŒŒì¼ = í•˜ë‚˜ì˜ ë„ë©”ì¸** (ë§ˆì¼ìŠ¤í†¤, ë³‘ì›, ì´ë¯¸ì§€ ë“±)
2. **400ì¤„ ì´í•˜ ìœ ì§€** (ê°€ë…ì„±)
3. **API ê²½ë¡œ ë³€ê²½ ê¸ˆì§€** (í•˜ìœ„ í˜¸í™˜ì„±)
4. **ë¯¸ë“¤ì›¨ì–´ ì¼ê´€ì„±** (ì¸ì¦, ê¶Œí•œ ì²´í¬)

---

### 5.2 ë¼ìš°í„° í…œí”Œë¦¿ (í‘œì¤€)

ëª¨ë“  ë¼ìš°í„°ëŠ” ì´ í…œí”Œë¦¿ì„ ë”°ë¦„:

```typescript
import { Router } from 'express';
import { requireAuth } from '../middleware/auth';
import { requireAdminOrSuperAdmin } from '../middleware/admin-auth';
import { asyncHandler } from '../utils/error-handler';
import { extractUserId, extractPagination } from '../utils/request-helpers';
import { logger } from '../utils/logger';

const router = Router();

/**
 * [ë„ë©”ì¸ëª…] ë¼ìš°í„°
 * - ì´ Xê°œ ì—”ë“œí¬ì¸íŠ¸
 * - ì¸ì¦ í•„ìš”: Xê°œ
 * - ê´€ë¦¬ì ì „ìš©: Xê°œ
 */

// ========================================
// ê³µê°œ API (ì¸ì¦ ë¶ˆí•„ìš”)
// ========================================

router.get('/api/[resource]/public', asyncHandler(async (req, res) => {
  // êµ¬í˜„
  res.json({ success: true, data: [] });
}));

// ========================================
// ì¸ì¦ í•„ìš” API
// ========================================

router.get('/api/[resource]', requireAuth, asyncHandler(async (req, res) => {
  const userId = extractUserId(req);
  const pagination = extractPagination(req);
  
  // êµ¬í˜„
  logger.info('Resource fetched', { userId });
  res.json({ success: true, data: [] });
}));

// ========================================
// ê´€ë¦¬ì ì „ìš© API
// ========================================

router.post('/api/admin/[resource]', requireAdminOrSuperAdmin, asyncHandler(async (req, res) => {
  const userId = extractUserId(req);
  
  // êµ¬í˜„
  logger.info('Resource created by admin', { userId });
  res.status(201).json({ success: true, data: {} });
}));

export default router;
```

---

### 5.3 ê°œë³„ ë¼ìš°í„° êµ¬í˜„ ê°€ì´ë“œ

#### **5.3.1 auth-routes.ts** (12ê°œ API)

```typescript
/**
 * ì¸ì¦ ë° íšŒì› ê´€ë¦¬ ë¼ìš°í„°
 * - ì´ 12ê°œ ì—”ë“œí¬ì¸íŠ¸
 * 
 * ê³µê°œ API:
 * - POST /api/auth/login
 * - POST /api/auth/register
 * - POST /api/auth/refresh
 * - POST /api/auth/verify-hospital-code
 * 
 * ì¸ì¦ í•„ìš”:
 * - POST /api/auth/logout
 * - GET /api/auth/me
 * - PUT /api/auth/profile
 * - PUT /api/auth/change-password
 * - GET /api/auth/notification-settings
 * - PUT /api/auth/notification-settings
 * - POST /api/auth/send-verification-email
 * - POST /api/auth/verify-email
 */

// ì£¼ìš” ë¡œì§:
// - JWT í† í° ë°œê¸‰/ê²€ì¦
// - ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (bcrypt)
// - ë³‘ì› ì½”ë“œ ê²€ì¦
// - ì„¸ì…˜ ê´€ë¦¬
```

**ì½”ë“œ ì´ë™:**
- routes.ts L500-800 â†’ auth-routes.ts

---

#### **5.3.2 milestone-routes.ts** (18ê°œ API)

```typescript
/**
 * ë§ˆì¼ìŠ¤í†¤ ì‹œìŠ¤í…œ ë¼ìš°í„°
 * - ì´ 18ê°œ ì—”ë“œí¬ì¸íŠ¸
 * - ë™ì  import 31íšŒ â†’ ì •ì  importë¡œ ë³€ê²½
 * 
 * ê³µê°œ API:
 * - GET /api/milestones (ëª©ë¡)
 * - GET /api/milestones/campaigns (ìº í˜ì¸ ëª©ë¡)
 * 
 * ì¸ì¦ í•„ìš”:
 * - GET /api/milestones/available
 * - GET /api/milestones/completed
 * - GET /api/milestones/stats
 * - POST /api/milestones/:milestoneId/complete
 * - POST /api/milestones/applications
 * - GET /api/milestones/applications
 * - GET /api/milestones/applications/:applicationId
 * - PATCH /api/milestones/applications/:applicationId/cancel
 * - GET /api/milestone-categories
 * - GET /api/milestone-categories/:categoryId
 * - GET /api/pregnancy-profile
 * - POST /api/pregnancy-profile
 * 
 * ê´€ë¦¬ì ì „ìš©:
 * - POST /api/admin/milestones
 * - PUT /api/admin/milestones/:milestoneId
 * - DELETE /api/admin/milestones/:milestoneId
 * - GET /api/admin/milestones
 */

// ì¤‘ìš”: ë™ì  import ì œê±°
// Before:
// const { getAllMilestones } = await import("./services/milestones");

// After:
import {
  getAllMilestones,
  getAvailableMilestones,
  // ... ëª¨ë‘ í•œ ë²ˆì—
} from '../services/milestones';
```

**ì½”ë“œ ì´ë™:**
- routes.ts L4800-6500 â†’ milestone-routes.ts

---

#### **5.3.3 hospital-routes.ts** (13ê°œ API)

```typescript
/**
 * ë³‘ì› ë° QR ì½”ë“œ ê´€ë¦¬ ë¼ìš°í„°
 * - ì´ 13ê°œ ì—”ë“œí¬ì¸íŠ¸
 * 
 * ê³µê°œ API:
 * - GET /api/hospitals (ë³‘ì› ëª©ë¡)
 * - GET /api/qr/hospital/:hospitalId/:codeId
 * - GET /api/qr/data/:hospitalId/:codeId
 * - POST /api/qr/verify
 * 
 * ì¸ì¦ í•„ìš”:
 * - GET /api/hospital/info
 * - GET /api/qr/generate/:hospitalId/:codeId
 * 
 * ë³‘ì› ê´€ë¦¬ì:
 * - (ë³‘ì› ì •ë³´ ìˆ˜ì • ë“±)
 * 
 * ê´€ë¦¬ì ì „ìš©:
 * - PATCH /api/admin/hospitals/:id/status
 * - GET /api/admin/hospital-codes
 * - POST /api/admin/hospital-codes
 * - DELETE /api/admin/hospital-codes/:id
 * - PATCH /api/admin/hospital-codes/:id/status
 * 
 * ìŠˆí¼ ê´€ë¦¬ì:
 * - GET /api/super/hospitals
 */
```

**ì½”ë“œ ì´ë™:**
- routes.ts L2000-2500, L7000-7500 â†’ hospital-routes.ts

---

#### **5.3.4 image-routes.ts** (18ê°œ API)

**ê¸°ì¡´ íŒŒì¼ ê°œì„ :**
- routes/image-routes.ts ì´ë¯¸ ì¡´ì¬
- í•˜ë“œì½”ë”© ì œê±°
- ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ 
- constants ì ìš©

```typescript
/**
 * ì´ë¯¸ì§€ ìƒì„± ë¼ìš°í„° (ê°œì„ )
 * - OpenAI gpt-image-1
 * - Google Gemini 2.5 Flash
 * - âŒ DALL-E ì ˆëŒ€ ê¸ˆì§€
 */

// ê°œì„  ì‚¬í•­:
// 1. ALLOWED_MIME_TYPES.IMAGES ì‚¬ìš©
// 2. FILE_LIMITS.MAX_IMAGE_SIZE ì‚¬ìš©
// 3. logger ì‚¬ìš©
// 4. asyncHandler ì ìš©
```

---

#### **5.3.5 ë‚˜ë¨¸ì§€ ë¼ìš°í„°** (11ê°œ)

ê° ë¼ìš°í„°ë³„ ê°€ì´ë“œ:

```
music-routes.ts (8ê°œ)
- TopMediai ìŒì•… ìƒì„±
- ìŠ¤íƒ€ì¼ ëª©ë¡
- ì‚¬ìš©ì ìŒì•… ì¡°íšŒ

chat-routes.ts (6ê°œ)
- OpenAI ì±„íŒ…
- ì±„íŒ… ê¸°ë¡ ì¡°íšŒ
- ì±„íŒ… ë‚´ë³´ë‚´ê¸°

gallery-routes.ts (4ê°œ)
- ê°¤ëŸ¬ë¦¬ ì¡°íšŒ
- ì´ë¯¸ì§€/ìŒì•… ëª©ë¡

concept-routes.ts (12ê°œ)
- ì»¨ì…‰ ê´€ë¦¬
- ì»¨ì…‰ ì¹´í…Œê³ ë¦¬
- ê´€ë¦¬ì CRUD

service-routes.ts (8ê°œ)
- ì„œë¹„ìŠ¤ ì•„ì´í…œ
- ì„œë¹„ìŠ¤ ì¹´í…Œê³ ë¦¬

banner-routes.ts (6ê°œ)
- ë°°ë„ˆ ì¡°íšŒ
- ë°°ë„ˆ ì—…ë¡œë“œ (ê´€ë¦¬ì)

persona-routes.ts (7ê°œ)
- í˜ë¥´ì†Œë‚˜ ê´€ë¦¬
- í˜ë¥´ì†Œë‚˜ ì¹´í…Œê³ ë¦¬

abtest-routes.ts (6ê°œ)
- AB í…ŒìŠ¤íŠ¸ ê´€ë¦¬
- í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìˆ˜ì§‘

admin-routes.ts (25ê°œ)
- ì‚¬ìš©ì ê´€ë¦¬
- ì‹œìŠ¤í…œ ì„¤ì •
- í†µê³„ ì¡°íšŒ

utility-routes.ts (9ê°œ)
- íŒŒì¼ ë‹¤ìš´ë¡œë“œ
- ë¯¸ë””ì–´ ì¡°íšŒ
- í…ŒìŠ¤íŠ¸ API
- ê³µê°œ API
```

---

### 5.4 ë©”ì¸ routes.ts ìµœì¢… í˜•íƒœ

**íŒŒì¼:** `server/routes.ts` (150ì¤„)

```typescript
import type { Express } from "express";
import { errorHandler, notFoundHandler } from "./middleware/error-handler";
import { stream } from "./utils/logger";
import morgan from "morgan";
import { initializeUploadDirectories } from "./config/upload-config";

// ìƒˆë¡œìš´ ë¼ìš°í„°ë“¤
import authRouter from './routes/auth-routes';
import userRouter from './routes/user-routes';
import milestoneRouter from './routes/milestone-routes';
import imageRouter from './routes/image-routes';
import musicRouter from './routes/music-routes';
import chatRouter from './routes/chat-routes';
import galleryRouter from './routes/gallery-routes';
import hospitalRouter from './routes/hospital-routes';
import qrRouter from './routes/qr-routes';
import conceptRouter from './routes/concept-routes';
import serviceRouter from './routes/service-routes';
import bannerRouter from './routes/banner-routes';
import personaRouter from './routes/persona-routes';
import abtestRouter from './routes/abtest-routes';
import adminRouter from './routes/admin-routes';
import utilityRouter from './routes/utility-routes';

// ê¸°ì¡´ ë¼ìš°í„°ë“¤
import musicEngineRouter from "./routes/music-engine-routes";
import collageRouter from "./routes/collage";
import bannerMigrationRouter from "./routes/banner-migration";
import googleOAuthRouter from "./routes/google-oauth";

export function registerRoutes(app: Express) {
  // ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ì´ˆê¸°í™”
  initializeUploadDirectories();

  // HTTP ë¡œê±°
  app.use(morgan('combined', { stream }));

  // ========================================
  // ë¼ìš°í„° ë“±ë¡ (ìˆœì„œ ì¤‘ìš”)
  // ========================================

  // ì¸ì¦ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
  app.use(authRouter);

  // ì‚¬ìš©ì
  app.use(userRouter);

  // í•µì‹¬ ê¸°ëŠ¥
  app.use(milestoneRouter);
  app.use(imageRouter);
  app.use(musicRouter);
  app.use(chatRouter);

  // ì»¨í…ì¸ 
  app.use(galleryRouter);
  app.use(conceptRouter);
  app.use(serviceRouter);
  app.use(bannerRouter);
  app.use(personaRouter);

  // ì‹œìŠ¤í…œ
  app.use(hospitalRouter);
  app.use(qrRouter);
  app.use(abtestRouter);

  // ê´€ë¦¬ì
  app.use(adminRouter);

  // ìœ í‹¸ë¦¬í‹°
  app.use(utilityRouter);

  // ê¸°ì¡´ ë¼ìš°í„° (í•˜ìœ„ í˜¸í™˜ì„±)
  app.use(musicEngineRouter);
  app.use(collageRouter);
  app.use(bannerMigrationRouter);
  app.use(googleOAuthRouter);

  // ========================================
  // ì—ëŸ¬ í•¸ë“¤ëŸ¬ (ë§ˆì§€ë§‰)
  // ========================================
  app.use(notFoundHandler);
  app.use(errorHandler);
}
```

---

### 5.5 Phase 2 ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

```
Phase 2 ì™„ë£Œ í›„ í™•ì¸ ì‚¬í•­:

â–¡ ëª¨ë“  ë¼ìš°í„° íŒŒì¼ ìƒì„± (16ê°œ)
  â–¡ auth-routes.ts
  â–¡ user-routes.ts
  â–¡ milestone-routes.ts
  â–¡ ... (13ê°œ ë”)

â–¡ routes.ts í¬ê¸° í™•ì¸
  â–¡ 200ì¤„ ì´í•˜
  â–¡ ì—ëŸ¬ í•¸ë“¤ëŸ¬ë§Œ ë‚¨ìŒ

â–¡ ì»´íŒŒì¼ ì„±ê³µ
  â–¡ LSP ì—ëŸ¬ 0ê°œ
  â–¡ TypeScript ë¹Œë“œ ì„±ê³µ

â–¡ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ (ê° ë¼ìš°í„°)
  â–¡ ì¸ì¦ API ë™ì‘
  â–¡ ë§ˆì¼ìŠ¤í†¤ API ë™ì‘
  â–¡ ë³‘ì› API ë™ì‘
  â–¡ ... (ëª¨ë“  ë¼ìš°í„°)

â–¡ ì„±ëŠ¥ í™•ì¸
  â–¡ í•« ë¦¬ë¡œë“œ 1-2ì´ˆ ì´ë‚´
  â–¡ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°ì†Œ

â–¡ í•˜ìœ„ í˜¸í™˜ì„±
  â–¡ ëª¨ë“  ê¸°ì¡´ API ê²½ë¡œ ë™ì‘
  â–¡ í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ ì—†ìŒ
```

---

## 6. Phase 3: ì„¸ë¶€ ì‹œìŠ¤í…œ ìˆ˜ì •

### 6.1 ë§ˆì¼ìŠ¤í†¤ LSP ì—ëŸ¬ ìˆ˜ì • (12ê°œ)

**ë¬¸ì œ:** `server/services/milestones.ts`
- milestoneId íƒ€ì… ë¶ˆì¼ì¹˜ (TEXT vs Number)

**ìˆ˜ì • ìœ„ì¹˜:**
```typescript
// Before: String íƒ€ì…ìœ¼ë¡œ ì²˜ë¦¬
const milestone = await db.query.milestones.findFirst({
  where: eq(milestones.id, milestoneId) // âŒ íƒ€ì… ì—ëŸ¬
});

// After: ëª…ì‹œì  íƒ€ì… ë³€í™˜
const milestone = await db.query.milestones.findFirst({
  where: eq(milestones.id, Number(milestoneId))
});
```

**ì „ì²´ ìˆ˜ì •:**
- 12ê³³ ëª¨ë‘ Number() ë³€í™˜ ì¶”ê°€
- íƒ€ì… ì •ì˜ ëª…í™•í™”

---

### 6.2 DB ì¸ë±ìŠ¤ ì¶”ê°€

```sql
-- ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•œ ì¸ë±ìŠ¤
CREATE INDEX IF NOT EXISTS idx_milestone_applications_user 
  ON milestone_applications(user_id);

CREATE INDEX IF NOT EXISTS idx_milestone_applications_status 
  ON milestone_applications(status);

CREATE INDEX IF NOT EXISTS idx_milestones_hospital 
  ON milestones(hospital_id) 
  WHERE hospital_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_users_member_type 
  ON users(member_type);

CREATE INDEX IF NOT EXISTS idx_images_user_category 
  ON images(user_id, category_id);

CREATE INDEX IF NOT EXISTS idx_music_user 
  ON music(user_id);

CREATE INDEX IF NOT EXISTS idx_banners_active 
  ON banners(is_active) 
  WHERE is_active = true;
```

---

### 6.3 ê¸°íƒ€ ì‹œìŠ¤í…œ ìµœì í™”

```
â–¡ ìºì‹± ë ˆì´ì–´ ì¶”ê°€ (ì„ íƒ)
  - Redis ì—°ë™
  - ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„° ìºì‹±

â–¡ ì´ë¯¸ì§€ ìµœì í™”
  - WebP ë³€í™˜ í™•ì¸
  - ì¸ë„¤ì¼ ìƒì„± í™•ì¸

â–¡ API ì‘ë‹µ í˜•ì‹ í†µì¼
  - ëª¨ë“  API { success, data, error } í˜•ì‹

â–¡ Rate Limiting ì ìš©
  - express-rate-limit
  - constants.tsì˜ RATE_LIMITS ì‚¬ìš©
```

---

## 7. ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 7.1 ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ (171ê°œ API)

**ì¹´í…Œê³ ë¦¬ë³„:**
```
â–¡ ì¸ì¦ (12ê°œ)
  â–¡ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
  â–¡ íšŒì›ê°€ì…
  â–¡ í”„ë¡œí•„ ìˆ˜ì •
  â–¡ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½

â–¡ ë§ˆì¼ìŠ¤í†¤ (18ê°œ)
  â–¡ ëª©ë¡ ì¡°íšŒ
  â–¡ ì‹ ì²­/ì™„ë£Œ
  â–¡ ê´€ë¦¬ì CRUD

â–¡ ì´ë¯¸ì§€ (18ê°œ)
  â–¡ OpenAI ìƒì„±
  â–¡ Gemini ìƒì„±
  â–¡ ê°¤ëŸ¬ë¦¬ ì¡°íšŒ

â–¡ ... (ë‚˜ë¨¸ì§€ ì¹´í…Œê³ ë¦¬)
```

---

### 7.2 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

```
â–¡ í•« ë¦¬ë¡œë“œ ì†ë„
  Target: 1-2ì´ˆ
  Current: ___ ì´ˆ

â–¡ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
  Target: ~5MB
  Current: ___ MB

â–¡ API ì‘ë‹µ ì‹œê°„
  Target: <200ms (í‰ê· )
  Current: ___ ms

â–¡ ë™ì‹œ ì ‘ì† í…ŒìŠ¤íŠ¸
  100ëª…: ___ ms
  500ëª…: ___ ms
  1000ëª…: ___ ms
```

---

### 7.3 ë³´ì•ˆ í…ŒìŠ¤íŠ¸

```
â–¡ ì¸ì¦ í™•ì¸
  â–¡ ë¹„ì¸ì¦ ìš”ì²­ ì°¨ë‹¨
  â–¡ JWT í† í° ê²€ì¦

â–¡ ê¶Œí•œ í™•ì¸
  â–¡ ì¼ë°˜ ì‚¬ìš©ì â†’ ê´€ë¦¬ì API ì°¨ë‹¨
  â–¡ ë³‘ì›ë³„ ë°ì´í„° ê²©ë¦¬

â–¡ SQL Injection í…ŒìŠ¤íŠ¸
  â–¡ Drizzle ORM ì‚¬ìš© (ì•ˆì „)

â–¡ XSS í…ŒìŠ¤íŠ¸
  â–¡ ì…ë ¥ê°’ ê²€ì¦
  â–¡ Zod ìŠ¤í‚¤ë§ˆ ì ìš©

â–¡ CSRF í…ŒìŠ¤íŠ¸
  â–¡ CORS ì„¤ì • í™•ì¸
```

---

### 7.4 ì½”ë“œ í’ˆì§ˆ

```
â–¡ LSP ì—ëŸ¬: 0ê°œ
â–¡ ESLint ê²½ê³ : 0ê°œ
â–¡ TypeScript strict mode: í†µê³¼
â–¡ ì¤‘ë³µ ì½”ë“œ: 0ê°œ
â–¡ í•˜ë“œì½”ë”©: 0ê°œ
â–¡ console.log: 0ê°œ (êµ¬ì¡°í™” ë¡œê¹…)
```

---

## 8. ìœ ì§€ë³´ìˆ˜ ê°€ì´ë“œ

### 8.1 ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì ˆì°¨

```
1. ìš”êµ¬ì‚¬í•­ ë¶„ì„
   - API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜
   - ë°ì´í„° ëª¨ë¸ ì„¤ê³„

2. DB ìŠ¤í‚¤ë§ˆ ì¶”ê°€
   - shared/schema.ts ìˆ˜ì •
   - npm run db:push

3. ì„œë¹„ìŠ¤ ë ˆì´ì–´ ìƒì„±
   - server/services/database/[feature]-service.ts

4. ë¼ìš°í„° ìƒì„± ë˜ëŠ” ìˆ˜ì •
   - ê¸°ì¡´ ë¼ìš°í„°ì— ì¶”ê°€ ë˜ëŠ”
   - ìƒˆ ë¼ìš°í„° íŒŒì¼ ìƒì„±

5. í…ŒìŠ¤íŠ¸
   - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
   - í†µí•© í…ŒìŠ¤íŠ¸

6. ë¬¸ì„œí™”
   - API ë¬¸ì„œ ì—…ë°ì´íŠ¸
   - replit.md ì—…ë°ì´íŠ¸
```

---

### 8.2 ì½”ë“œ ì»¨ë²¤ì…˜

```typescript
// âœ… Good
import { Router } from 'express';
import { requireAuth } from '../middleware/auth';
import { extractUserId } from '../utils/request-helpers';
import { logger } from '../utils/logger';
import { UserService } from '../services/database/user-service';

const router = Router();

router.get('/api/users/me', requireAuth, asyncHandler(async (req, res) => {
  const userId = extractUserId(req);
  const user = await UserService.findById(userId);
  
  logger.info('User profile fetched', { userId });
  res.json({ success: true, data: user });
}));

// âŒ Bad
router.get('/api/users/me', async (req, res) => {
  try {
    const userId = Number(req.user?.id);
    const user = await db.query.users.findFirst({
      where: eq(users.id, userId)
    });
    console.log('User:', user);
    res.json(user);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Error' });
  }
});
```

---

### 8.3 íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

**ë¬¸ì œ 1: í•« ë¦¬ë¡œë“œ ëŠë¦¼**
```
ì›ì¸: ê±°ëŒ€í•œ íŒŒì¼ ë³€ê²½
í•´ê²°: ë¦¬íŒ©í† ë§ ì™„ë£Œ ì‹œ ìë™ í•´ê²°
```

**ë¬¸ì œ 2: íƒ€ì… ì—ëŸ¬**
```
ì›ì¸: ID íƒ€ì… ë¶ˆì¼ì¹˜
í•´ê²°: extractUserId() ì‚¬ìš©, Number() ë³€í™˜
```

**ë¬¸ì œ 3: ì¤‘ë³µ ì½”ë“œ**
```
ì›ì¸: ë³µì‚¬-ë¶™ì—¬ë„£ê¸°
í•´ê²°: ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì‚¬ìš©
```

---

## 9. ê¸´ê¸‰ ë¡¤ë°± ì ˆì°¨

### 9.1 ë¡¤ë°± í¬ì¸íŠ¸

```
replit.md ì°¸ì¡°:
- 2025-10-21: ë¦¬íŒ©í† ë§ ì‹œì‘ ì „ ì•ˆì • ë²„ì „
```

### 9.2 ë¡¤ë°± ë°©ë²•

```
1. Replit UIì—ì„œ History íƒ­ ì—´ê¸°
2. "ë¦¬íŒ©í† ë§ ì‹œì‘ ì „" ì²´í¬í¬ì¸íŠ¸ ì°¾ê¸°
3. "Restore" ë²„íŠ¼ í´ë¦­
4. ë°ì´í„°ë² ì´ìŠ¤ë„ í•¨ê»˜ ë¡¤ë°±í• ì§€ ì„ íƒ
```

### 9.3 ë¶€ë¶„ ë¡¤ë°±

íŠ¹ì • íŒŒì¼ë§Œ ë˜ëŒë¦¬ê¸°:
```bash
# Git ê¸°ë°˜
git log --oneline
git checkout [commit-hash] -- server/routes.ts
```

---

## 10. íƒ€ì„ë¼ì¸

### ì˜ˆìƒ ì¼ì •

```
Day 1: Phase 1 (ê¸°ë°˜ êµ¬ì¶•)
  - ê³µí†µ ìœ í‹¸ë¦¬í‹° ìƒì„±
  - DB ì„œë¹„ìŠ¤ ë ˆì´ì–´

Day 2-3: Phase 2-1 (ê¸´ê¸‰ ë¼ìš°í„°)
  - milestone-routes.ts
  - auth-routes.ts
  - hospital-routes.ts

Day 4-5: Phase 2-2 (í•µì‹¬ ë¼ìš°í„°)
  - image-routes.ts ê°œì„ 
  - music-routes.ts
  - chat-routes.ts
  - admin-routes.ts

Day 6-7: Phase 2-3 (ë‚˜ë¨¸ì§€ ë¼ìš°í„°)
  - 11ê°œ ë¼ìš°í„° ë¶„ë¦¬

Day 8: Phase 3 (ì„¸ë¶€ ìˆ˜ì •)
  - ë§ˆì¼ìŠ¤í†¤ LSP ì—ëŸ¬
  - DB ì¸ë±ìŠ¤
  - ìµœì í™”

Day 9-10: ê²€ì¦ ë° í…ŒìŠ¤íŠ¸
  - ì „ì²´ API í…ŒìŠ¤íŠ¸
  - ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
  - ë¬¸ì„œ ì—…ë°ì´íŠ¸
```

---

## 11. ì„±ê³µ ê¸°ì¤€ (ìµœì¢…)

### ì •ëŸ‰ì  ì§€í‘œ
```
âœ… routes.ts: 9,293ì¤„ â†’ 150ì¤„ (-98.4%)
âœ… LSP ì—ëŸ¬: 12ê°œ â†’ 0ê°œ
âœ… ì¤‘ë³µ ì½”ë“œ: 100+ â†’ 0
âœ… í•˜ë“œì½”ë”©: ë‹¤ìˆ˜ â†’ 0
âœ… í•« ë¦¬ë¡œë“œ: 8-12ì´ˆ â†’ 1-2ì´ˆ
âœ… ë©”ëª¨ë¦¬: 20MB â†’ 5MB
```

### ì •ì„±ì  ì§€í‘œ
```
âœ… ì½”ë“œ ê°€ë…ì„±: í–¥ìƒ
âœ… ìœ ì§€ë³´ìˆ˜ì„±: ê·¹ëŒ€í™”
âœ… íŒ€ í˜‘ì—…: Git ì¶©ëŒ 70% ê°ì†Œ
âœ… í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ê°€ëŠ¥
âœ… í™•ì¥ì„±: ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ìš©ì´
```

---

**ğŸ¯ ì´ ê³„íšì„œë¥¼ ë”°ë¼ ë‹¨ê³„ë³„ë¡œ ì§„í–‰í•˜ë©´ ì™„ë²½í•œ ë¦¬íŒ©í† ë§ì´ ì™„ë£Œë©ë‹ˆë‹¤.**

**ğŸ“Œ ì¤‘ìš”: ê° Phase ì™„ë£Œ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸ í™•ì¸ í•„ìˆ˜!**

---

**ì‘ì„±:** Replit Agent  
**ë²„ì „:** 1.0 (Master Plan)  
**ìµœì¢… ì—…ë°ì´íŠ¸:** 2025-10-21  
**íŒŒì¼:** docs/REFACTORING_MASTER_PLAN.md
