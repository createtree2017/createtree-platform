# ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë¡œì§ ìˆ˜ì •

## ğŸ“‹ ê°œìš”
- ëª©ì : ë¡œê·¸ì•„ì›ƒ ì‹œ ë©”ì¸í™”ë©´ ì´ì¤‘ ë¡œë”© ë²„ê·¸ ìˆ˜ì • ë° ìë™ ë¡œê·¸ì¸ ì‹œ DB ë°ì´í„° ë¯¸í‘œì‹œ ë¬¸ì œ í•´ê²°
- ê´€ë ¨ íŒŒì¼:
  - `client/src/hooks/useAuth.ts`
  - `client/src/lib/queryClient.ts`
  - `client/src/App.tsx`
  - `client/src/components/admin/ConceptManagement.tsx`
  - `client/src/utils/image-url-resolver.ts`

## ğŸ“… ì‘ì—… ì´ë ¥
| ë‚ ì§œ | ì‘ì—… ë‚´ìš© |
|------|----------|
| 2026-02-13 | ì „ìˆ˜ì¡°ì‚¬ (6ê°€ì§€ ë²„ê·¸ ë°œê²¬), ì˜ì¡´ì„± ë¶„ì„ (70+ íŒŒì¼), 7ê°€ì§€ ìˆ˜ì • ì‹¤í–‰, ê²€ì¦ ì™„ë£Œ |

## ğŸ” ë¬¸ì œ ë¶„ì„

### ë²„ê·¸ #1: ë¡œê·¸ì•„ì›ƒ ì‹œ ë©”ì¸í™”ë©´ ì´ì¤‘ ë¡œë”©
- **ì›ì¸**: `useAuth.ts`ì˜ logout onSuccessì—ì„œ `queryClient.clear()` â†’ ì „ì²´ refetch â†’ 1ì´ˆ í›„ `window.location.href` â†’ ë˜ ë¦¬ë¡œë“œ
- **ê²°ê³¼**: í™”ë©´ 3ë²ˆ ê¹œë¹¡ì„

### ë²„ê·¸ #2: httpOnly ì¿ í‚¤ `document.cookie` ì ‘ê·¼ ì‹œë„ (5ê³³)
- **ì›ì¸**: `auth_token` ì¿ í‚¤ê°€ `httpOnly`ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ `document.cookie`ë¡œ ì½ì„ ìˆ˜ ì—†ìŒ
- **ì˜í–¥ íŒŒì¼**: `queryClient.ts` (2ê³³), `ConceptManagement.tsx`, `image-url-resolver.ts`, `useAuth.ts` (trailing space)
- **ê²°ê³¼**: API ìš”ì²­ì— Authorization í—¤ë” ëˆ„ë½

### ë²„ê·¸ #3: OAuth ì½œë°± ì¤‘ë³µ ì²˜ë¦¬
- **ì›ì¸**: `App.tsx`ì™€ `AuthProvider.tsx` ì–‘ìª½ì—ì„œ ë™ì¼ í† í° ì €ì¥ â†’ Race condition

## ğŸ› ï¸ ìˆ˜ì • ë‚´ìš©

### ìˆ˜ì • 1: JWT trailing space ì œê±° (`useAuth.ts` line 82)
```diff
-headers["Authorization"] = `Bearer ${jwtToken} `;
+headers["Authorization"] = `Bearer ${jwtToken}`;
```

### ìˆ˜ì • 2: Logout onSuccess ë‹¨ìˆœí™” (`useAuth.ts`)
```diff
 queryClient.setQueryData(["/api/auth/me"], null);
-queryClient.invalidateQueries({ queryKey: ["/api/auth/me"] });
-queryClient.removeQueries({ queryKey: ["/api/auth/me"] });
-queryClient.clear();
-toast({ title: "ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ", ... });
-setTimeout(() => { window.location.href = "/auth"; }, 1000);
+window.location.href = "/auth";
```

### ìˆ˜ì • 3~5: httpOnly ì¿ í‚¤ â†’ localStorage ë³€ê²½ (3ê°œ íŒŒì¼)
ëª¨ë“  `getCookieValue('auth_token')` í˜¸ì¶œì„ `localStorage.getItem('auth_token')`ìœ¼ë¡œ êµì²´:
- `queryClient.ts` â€” `defaultQueryFn` ë° `apiRequest` í•¨ìˆ˜ (2ê³³)
- `ConceptManagement.tsx` â€” `uploadImage` í•¨ìˆ˜
- `image-url-resolver.ts` â€” `requestNewSignedUrl` í•¨ìˆ˜

### ìˆ˜ì • 6: OAuth ì½œë°± ì¤‘ë³µ ì œê±° (`App.tsx`)
`App.tsx`ì—ì„œ OAuth í† í° ì €ì¥ ë¡œì§ ì œê±° â†’ `AuthProvider.tsx`ì—ì„œ í†µí•© ì²˜ë¦¬

## âœ… ê²€ì¦ ê²°ê³¼
- TypeScript ë¹Œë“œ: âœ… ì„±ê³µ (ê¸°ì¡´ ë¹„ê´€ë ¨ ë°±ì—… íŒŒì¼ ì—ëŸ¬ 1ê°œë§Œ ì¡´ì¬)
- `getCookieValue` ì”ì¡´: âœ… 0ê±´ (ì™„ì „ ì œê±°)
- `queryClient.clear()` ì”ì¡´: âœ… 0ê±´ (ì™„ì „ ì œê±°)
- ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸: âœ… ë‹¨ì¼ ì „í™˜ í™•ì¸
- ìë™ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸: âœ… ë°ì´í„° ì •ìƒ í‘œì‹œ
- Google OAuth: â³ ì¶”í›„ í…ŒìŠ¤íŠ¸ ì˜ˆì •

## âš ï¸ ì£¼ì˜ì‚¬í•­
- `apiClient.ts`ì— ë³„ë„ `queryClient` ì¸ìŠ¤í„´ìŠ¤ ì¡´ì¬ â€” ìˆ˜ì • ì•ˆ í•¨ (ì´ë¯¸ `credentials: 'include'`ë§Œ ì‚¬ìš©í•˜ì—¬ ì •ìƒ)
- `firebase-upload.ts`, `ImageGenerationTemplate.tsx`ì˜ `localStorage.getItem('auth_token')` â€” ìˆ˜ì • ì•ˆ í•¨ (ì´ë¯¸ ì˜¬ë°”ë¥¸ ë°©ì‹)
- ì„œë²„ ë¯¸ë“¤ì›¨ì–´(`requireAuth`)ëŠ” ì¿ í‚¤ + Authorization í—¤ë” ë‘˜ ë‹¤ ì§€ì› â†’ ìˆ˜ì • ë¶ˆí•„ìš”
