# 핵심 탭 URL 라우팅 기반 상태 관리 리팩토링 설계서

## 1. 개요

- **기능명**: 핵심 탭(관리자, 갤러리 등) URL 라우팅 전환 및 뒤로가기 중앙 통제 호환성 설계
- **작성일**: 2026-03-01
- **Plan 참조**: `docs/01-plan/features/1-20260301-핵심탭_URL_라우팅_전환.plan.md`

## 2. 현황 분석 및 문제 정의

1.  **관리자 페이지 (`admin.tsx`)**
    - 현재 5개의 메인 탭(메뉴관리, 회원관리 등) 표면은 약간의 URL 파라미터를 읽고 반영하려 구현되어 있으나, 서브 탭(병원관리, 코드관리 등) 깊은 곳까지 100% 이벤트가 매끄럽게 연결되지 못함.
    - 특히 `MenuManagement.tsx`, `MissionManagement.tsx` 등의 내부 아코디언 컴포넌트에 딸린 수십 개의 인라인 탭은 순수 `useState`로 동작하여 뒤로 가기 관찰 목록에서 제외됨.
2.  **사용자 페이지 - 갤러리 (`gallery-simplified.tsx`)**
    - `sessionStorage`를 이용해 'image'와 'studio' 탭을 억지로 기억하게 꼼수(Hack) 방식을 쓰고 있음. URL 쿼리(예: `?tab=studio`)를 전혀 사용하지 않아 브라우저 히스토리 조작이나 공유하기 링크를 만들 수 없음.
3.  **사용자 페이지 - 문화센터/히스토리 탭**
    - 현재 탭 네비게이션이 컴포넌트 내부 State 로직에 잠겨있을 가능성 높음. (마이그레이션 대상)

## 3. 리팩토링 대상 파일 및 구현 스펙

### 3.1. 관리자 뎁스 (High Priority)

- **`client/src/pages/admin.tsx`**
  - **As-Is**: `window.history.pushState`를 써서 메인/서브 탭 이동 시 억지로 URL을 바꾸긴 하나 기록이 무한정 누적되어 뒤로가기 지옥 생성 가능성 있음.
  - **To-Be**:
    - `wouter`의 훅을 사용하거나 `URLSearchParams`를 더 정교하게 다듦.
    - 뒤로 가기가 필요 없는 탭 전환에는 **`window.history.replaceState`**로 로직 전면 수정 (★핵심).
- **`client/src/components/admin/MenuManagement.tsx`**
  - **수정 목표**: "관리 기능(MENU_SUB_PANELS)" 속 내부 탭 컴포넌트 변경을 감지하고, 해당 Panel value를 `?sub=...` 형태로 URL과 즉시 동기화하도록 `onValueChange` 이벤트와 URL 업데이트 융합.

### 3.2. 프론트 사용자 뎁스 (Medium Priority)

- **`client/src/pages/gallery-simplified.tsx`**
  - **As-Is**: `const [activeMainTab] = useState(() => sessionStorage.getItem(...) || 'image');`
  - **To-Be**: 세션 스토리지 완전 폐기. 철저하게 URL 쿼리 파라미터(`?tab=image` 또는 `?tab=studio`)로만 초기값을 세팅하고, 탭 버튼 클릭 시 URL을 `replaceState`로 변경.
- **문화센터 내부 탭 (히스토리/진행중 등)**
  - 위 갤러리 패턴과 동일하게 조사 후 URL 쿼리 기반 탭으로 마이그레이션 (`?tab=history` 등).

## 4. 이벤트 버스 및 라우팅 정책 (뒤로가기 방어선)

```javascript
/**
 * 탭을 덮어씌울 때 사용하는 공통 URL 헬퍼 로직(설계)
 */
function updateTabUrl(newTabKey: string, isSubTab = false) {
  const url = new URL(window.location.href);

  // 1. URL 파라미터 수정
  url.searchParams.set(isSubTab ? 'sub' : 'tab', newTabKey);

  // 2. 기록 누적 방지를 위해 무조건 "Replace" 사용 (히스토리 지옥 방지)
  // 단, 타 페이지(홈)에서 관리자로 막 진입한 '첫 탭 노출' 상태는 브라우저가 알아서 Push 남김.
  window.history.replaceState({}, '', url.toString());

  // 3. (선택) popstate 이벤트를 강제 발생시켜 React 상태 동기화를 트리거할 지, State 변환을 병행할 지 결정
}
```

## 5. 단계별 검증 절차 (Verification Plan)

### (1) 관리자 탭 뒤로가기 검증

- [ ] `/admin` 에 접속.
- [ ] "마일스톤" 메인 탭을 클릭. -> URL이 `?tab=milestones`로 "바뀌는지" 확인.
- [ ] 그 내부의 "카테고리" 서브 탭 클릭. -> URL이 `?tab=milestones&sub=milestone-categories`로 바뀌는지 확인.
- [ ] 이 상태에서 PC 브라우저 **[새로고침(F5)]** 클릭. -> 초기화되지 않고 "마일스톤-카테고리" 화면이 바로 떠야 성공.
- [ ] 이 상태에서 PC 브라우저 좌상단 **[뒤로가기 버튼(<-)]** 클릭. -> `pushState` 지옥이 없어 바로 이전 큰 화면(관리자 진입 전 화면)으로 빠져나가는지 확인.

### (2) 갤러리 탭 검증

- [ ] `/gallery-simplified` 접속.
- [ ] "제작소갤러리" 버튼 클릭 -> URL 파라미터가 `?tab=studio`로 변하는지 확인.
- [ ] 해당 주소(`localhost:5000/gallery-simplified?tab=studio`)를 복사해서 새 브라우저 탭에 붙여넣기(DeepLink 테스트) -> 기본 이미지 갤러리가 아닌 제작소 갤러리가 바로 로드되어야 성공.

## 6. 결론

URL 쿼리(`?tab=`) 체제로 통일하고 `replaceState`를 메인 엔진으로 채택하면, **1) 새로고침 보존, 2) 딥링크 공유 기능, 3) 불필요한 스마트폰 뒤로가기 누적 현상** 세 가지를 동시에 완벽히 해결할 수 있습니다.
디자인 검토 완료 후 바로 `Execute` 모드로 전환하여 코드를 수정합니다.
