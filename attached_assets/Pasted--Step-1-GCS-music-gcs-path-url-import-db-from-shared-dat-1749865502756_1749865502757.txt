// âœ… Step 1. GCS íŒŒì¼ì„ music í…Œì´ë¸”ê³¼ ìë™ ì—°ê²°í•˜ì—¬ gcs_path + url í•„ë“œ ê°±ì‹ 

import { db } from "../../shared/database";
import { music } from "../../shared/schema";
import { and, eq } from "drizzle-orm";
import { Storage } from "@google-cloud/storage";

const storage = new Storage();
const bucket = storage.bucket("createtree-upload");
const prefix = "music/";

async function syncGcsMusicToDb() {
  const [files] = await bucket.getFiles({ prefix });

  const dbRecords = await db
    .select({ id: music.id, createdAt: music.created_at })
    .from(music)
    .where(eq(music.status, "completed"));

  for (const file of files) {
    const fileName = file.name.replace(prefix, "");
    const [metadata] = await file.getMetadata();
    const gcsTime = new Date(metadata.timeCreated);

    // created_atê³¼ ê°€ì¥ ë¹„ìŠ·í•œ ë ˆì½”ë“œ ì°¾ê¸°
    let matchedId = null;
    let minDiff = Infinity;

    for (const rec of dbRecords) {
      const diff = Math.abs(new Date(rec.createdAt).getTime() - gcsTime.getTime());
      if (diff < 60000 && diff < minDiff) { // 60ì´ˆ ì´ë‚´ ìœ ì‚¬í•œ ê²½ìš°ë§Œ í—ˆìš©
        minDiff = diff;
        matchedId = rec.id;
      }
    }

    if (matchedId) {
      const gcsUrl = `https://storage.googleapis.com/createtree-upload/${file.name}`;
      await db
        .update(music)
        .set({ gcs_path: fileName, url: gcsUrl })
        .where(eq(music.id, matchedId));
      console.log(`âœ… Updated music ID ${matchedId} â†’ ${fileName}`);
    } else {
      console.log(`âš ï¸  No match for file: ${fileName}`);
    }
  }
}

// âœ… Step 2. ìŒì•… ìƒì„± ì§í›„ GCS ì—…ë¡œë“œ í›„ DBì— url ë° gcs_path ì €ì¥ í•¨ìˆ˜
export async function saveMusicToDb(musicId: number, gcsFileName: string) {
  const gcsUrl = `https://storage.googleapis.com/createtree-upload/music/${gcsFileName}`;
  await db.update(music)
    .set({ gcs_path: gcsFileName, url: gcsUrl })
    .where(eq(music.id, musicId));
  console.log(`ğŸµ Music DB Updated â†’ ID: ${musicId}, URL: ${gcsUrl}`);
}

syncGcsMusicToDb().then(() => console.log("ğŸ¯ DB ë™ê¸°í™” ì™„ë£Œ")).catch(console.error);
