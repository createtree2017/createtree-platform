업로드해 주신 `gemini.ts` 파일의 `transformWithGemini3` 함수를 분석한 결과, **구글의 Gemini 3.0 Pro Image(나노바나나 프로) API가 요구하는 특정 데이터 형식과 대소문자 규칙**에서 몇 가지 문제점이 발견되었습니다.

해상도(`imageSize`)가 적용되지 않는 주요 원인과 해결 방법은 다음과 같습니다.

---

## 1. 문제 원인 분석

### ① `imageConfig` 객체의 위치 문제

현재 코드에서는 `config` 객체 바로 안에 `imageConfig`를 넣고 있습니다. 하지만 Gemini 3.0 Pro Image API의 공식 구조(SDK 기준)에서 이미지 생성 관련 옵션은 **`generationConfig`** 내부에 포함되거나, 모델 호출 시 별도의 파라미터로 정의되어야 합니다.

### ② 해상도 값의 엄격한 형식 (Strict Case-Sensitivity)

코드 내에 `formattedImageSize`를 통해 대문자 변환(`toUpperCase()`)을 하고 계신 점은 매우 좋습니다. API 가이드라인에 따르면 `2k`는 거부되며 반드시 **`2K`**, **`4K`**와 같이 대문자를 사용해야 합니다.

### ③ `responseModalities` 설정의 우선순위

`responseModalities`에 `TEXT`와 `IMAGE`가 모두 포함되어 있는데, 모델에 따라 `IMAGE` 전용으로 설정하지 않으면 기본 해상도로 텍스트 응답과 함께 생성되는 경우가 발생할 수 있습니다.

---

## 2. 수정된 코드 (해결책)

`transformWithGemini3` 함수의 요청 구성 부분을 다음과 같이 수정해야 합니다.

```typescript
// ... 기존 코드 생략 ...

// 대소문자 강제 변환 (반드시 대문자 K 사용)
const formattedImageSize = imageSize ? imageSize.toUpperCase() : undefined;

/**
 * 수정된 Config 구조
 * Gemini 3.0 Pro Image는 generationConfig 내부에 imageConfig를 배치해야 정확히 인식합니다.
 */
const generationConfig: any = {
  responseModalities: ["IMAGE"], // 이미지 생성이 주 목적이라면 IMAGE를 우선순위로 설정
  temperature: 1.0,
  topP: 0.95,
};

// 이미지 설정 주입
if (aspectRatio || formattedImageSize) {
  generationConfig.imageConfig = {};
  if (aspectRatio) {
    generationConfig.imageConfig.aspectRatio = aspectRatio;
  }
  if (formattedImageSize) {
    // 1K, 2K, 4K 중 하나여야 함
    generationConfig.imageConfig.imageSize = formattedImageSize;
  }
}

console.log('🔧 [Gemini 3.0] 수정된 API 요청 config:', JSON.stringify(generationConfig, null, 2));

const response = await genAI.models.generateContent({
  model: modelName,
  contents,
  config: generationConfig // 변수명을 config로 전달하거나 generationConfig로 매핑
});

// ... 이후 로직 동일 ...

```

---

## 3. 체크리스트: 이것도 확인해 보세요!

1. **모델명 확인:** 코드에서 사용 중인 `gemini-3-pro-image-preview` 모델명이 현재 사용 중인 GCP 프로젝트나 Vertex AI 리전에서 지원되는 정확한 명칭인지 다시 한번 확인해 주세요. (특정 지역에서는 `gemini-3.0-pro-vision-latest` 등 명칭이 다를 수 있습니다.)
2. **해상도 지원 범위:** `4K` 옵션은 Gemini 3.0 Pro **Ultra** 또는 특정 티어에서만 활성화될 수 있습니다. 만약 `4K` 설정 시 에러가 난다면 `2K`로 테스트하여 설정값 전달 여부를 먼저 파악하는 것이 좋습니다.
3. **이미지 크기 로그 확인:** 수정 후 생성된 `imageData.length`를 출력하는 로그를 확인해 보세요. 해상도가 정상 적용되었다면 파일 크기가 기존보다 최소 2~4배 이상 커져야 합니다.

---

**수정된 코드를 적용해 보시겠어요?** 만약 여전히 적용되지 않는다면, API 호출 시 발생하는 **에러 메시지 전문**이나 **실제 응답 JSON 구조**를 보여주시면 더 정밀하게 진단해 드릴 수 있습니다.