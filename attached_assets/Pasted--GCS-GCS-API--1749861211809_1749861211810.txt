// ğŸ¯ ë¼í”Œ ì‘ì—…ì§€ì‹œì„œ: GCS ê¸°ë°˜ ìŒì•… ìŠ¤íŠ¸ë¦¬ë° êµ¬ì¡° ì¬ì„¤ê³„

// âœ… ëª©ì : ìŒì•…ì´ GCS ë˜ëŠ” ë¡œì»¬ì— ì €ì¥ë˜ì–´ ìˆì„ ê²½ìš°, ì•ˆì •ì ìœ¼ë¡œ ì¬ìƒ ê°€ëŠ¥í•œ ìŠ¤íŠ¸ë¦¬ë° API êµ¬í˜„
// âŒ ê¸ˆì§€ì‚¬í•­: static í´ë”ë¡œ í•˜ë“œì½”ë”© ì´ë™, HTML í˜ì´ì§€ë¥¼ mp3ë¡œ ì €ì¥, í•„í„°ë§ìœ¼ë¡œ ì˜¤ë¥˜ ì€í

import express from 'express';
import { db } from '../db';
import { music } from '../db/schema';
import { eq } from 'drizzle-orm';
import fs from 'fs';
import path from 'path';

const router = express.Router();

router.get('/api/music/stream/:id', async (req, res) => {
  const { id } = req.params;
  const range = req.headers.range || 'bytes=0-';

  const found = await db.select().from(music).where(eq(music.id, Number(id))).limit(1);
  if (!found.length) return res.status(404).send('Music not found');

  const musicData = found[0];
  const musicUrl = musicData.url;

  // âœ… ë¡œì»¬ íŒŒì¼ì¸ ê²½ìš° (e.g. /static/music/abc.mp3)
  if (musicUrl.startsWith('/static/')) {
    const filePath = path.join(process.cwd(), musicUrl);
    if (!fs.existsSync(filePath)) return res.status(404).send('Local file not found');

    const stat = fs.statSync(filePath);
    const fileSize = stat.size;
    const start = Number(range.replace(/bytes=/, '').split('-')[0]);
    const end = fileSize - 1;
    const chunkSize = end - start + 1;

    const stream = fs.createReadStream(filePath, { start, end });
    res.writeHead(206, {
      'Content-Range': `bytes ${start}-${end}/${fileSize}`,
      'Accept-Ranges': 'bytes',
      'Content-Length': chunkSize,
      'Content-Type': 'audio/mpeg',
    });
    stream.pipe(res);
    return;
  }

  // âœ… GCS URLì¸ ê²½ìš° (Signed URL ë˜ëŠ” Public URL)
  try {
    const gcsRes = await fetch(musicUrl, {
      headers: { Range: range },
    });

    const contentType = gcsRes.headers.get('Content-Type') || '';
    if (!gcsRes.ok || !gcsRes.body || !contentType.includes('audio')) {
      return res.status(502).send('Invalid audio file or fetch failed');
    }

    for (const [key, value] of gcsRes.headers.entries()) {
      res.setHeader(key, value);
    }
    res.status(gcsRes.status);
    gcsRes.body.pipe(res);
  } catch (err) {
    console.error('GCS fetch error:', err);
    res.status(500).send('Stream error');
  }
});

export default router;

// âœ… ì ìš© ì‹œ ì£¼ì˜ì‚¬í•­:
// 1. music.url í•„ë“œëŠ” ì ˆëŒ€ í•˜ë“œì½”ë”©ëœ static ê²½ë¡œë¡œ ë®ì–´ì“°ì§€ ë§ ê²ƒ
// 2. GCSëŠ” ë°˜ë“œì‹œ í¼ë¸”ë¦­ URL ë˜ëŠ” Signed URLì´ì–´ì•¼ í•¨
// 3. HTMLì„ mp3ì²˜ëŸ¼ ì €ì¥í•˜ê±°ë‚˜, ì¸ì¦ ì‹¤íŒ¨ í˜ì´ì§€ ì €ì¥ì€ ì¦‰ì‹œ ì œê±°í•  ê²ƒ
// 4. ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹œ 206 ì‘ë‹µ + audio/mpeg + Range í—¤ë” í•„ìˆ˜
