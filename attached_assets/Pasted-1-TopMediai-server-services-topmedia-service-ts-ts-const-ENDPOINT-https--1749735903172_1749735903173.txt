1. TopMediai 서비스 수정 /server/services/topmedia-service.ts
엔드포인트 정정

ts
복사
편집
const ENDPOINT = 'https://api.topmediai.com/v2/submit';
요청 파라미터

ts
복사
편집
interface SubmitBody {
  is_auto: 0 | 1;       // 수동/자동
  prompt: string;       // 1–200 글자
  lyrics: string;       // <= 1000 chars, '' 허용
  title: string;        // 1–100 글자
  instrumental: 0 | 1;
  model_version: 'v4.0' | 'v3.5' | 'v3.0';
}
가사 길이 검증 & 자동 줄이기 제거

ts
복사
편집
if (body.lyrics.length > 1000) {
  throw new Error('Lyrics length exceeds 1000 characters');
}
타임아웃·재시도

ts
복사
편집
const controller = new AbortController();
const TIMEOUT = 180_000; // 3분
setTimeout(() => controller.abort(), TIMEOUT);

// axios-retry 3회 (지수 백오프 2^n * 3s)
응답 처리
– data.id 수신 후 /v2/query?id=... 폴링 (5 s 간격, 최대 3 min).
– task_status === 'success' → audio_url 추출.

2. GCS 업로드 모듈 /server/utils/gcs.ts
ts
복사
편집
export async function uploadToGCS(remoteUrl: string, targetPath: string) {
  const bucket = storage.bucket(process.env.GCS_BUCKET!);
  const res = await fetch(remoteUrl);
  await new Promise((ok, err) =>
    res.body.pipe(bucket.file(targetPath).createWriteStream())
      .on('finish', ok)
      .on('error', err)
  );
  return `https://storage.googleapis.com/${process.env.GCS_BUCKET}/${targetPath}`;
}
3. Music Service /server/services/music-service.ts
TopMediai 생성 성공 시:

ts
복사
편집
const gcsPath = `music/${songId}.mp3`;
const finalUrl = await uploadToGCS(audioUrl, gcsPath);
await db.insert(music).values({ …, url: finalUrl, status: 'completed' });
실패 시: status='failed', error_message 저장. GPT 대체 오디오는 옵션.

4. Front-end 개선
MusicForm – lyrics textarea 길이 표시(1000자 max)

Status Banner – 진행 / 실패 / GCS 업로드 중 여부 표시

Retry 버튼 → 동일 파라미터로 재호출

5. ENV 변수
ini
복사
편집
TOPMEDIA_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
GCS_BUCKET=createtree-music
추가 확인 사항
422 응답 테스트: 모델 버전·필드명 누락 시 그대로 재현 → 에러 매핑 테이블 작성.

/v1/lyrics 엔드포인트는 여전히 1 200 ms 내 응답, 유지보수 종료 확인 필요.
(가사 자동 생성이 충분히 좋다면 is_auto=1 고정도 고려).

위 지침대로 수정-배포 후 DB에 새 레코드가 completed + GCS URL 로 들어오면 정상입니다.
추가 API 변경사항 발견 시 문서( https://docs.topmediai.com ) 에서 버전만 교체하면 됩니다.