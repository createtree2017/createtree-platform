// ğŸ“¦ ì‘ì—…ì§€ì‹œì„œ: ê¸°ì¡´ ì´ë¯¸ì§€ ì¸ë„¤ì¼ ìƒì„± + API ì•ˆì •í™” + í´ë¼ì´ì–¸íŠ¸ fallback ì²˜ë¦¬

// ğŸ¯ ë¬¸ì œ ìš”ì•½
// - ê¸°ì¡´ ì´ë¯¸ì§€ì— ì¸ë„¤ì¼ì´ ì—†ì–´ì„œ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ê·¸ëŒ€ë¡œ ë¡œë”© ì¤‘ (ë§¤ìš° ëŠë¦¼)
// - ì¸ë„¤ì¼ í•„ë“œ ì ‘ê·¼ ì‹œ null ê°’ìœ¼ë¡œ ì¸í•´ APIì—ì„œ 500 ì˜¤ë¥˜ ë°œìƒ
// - í´ë¼ì´ì–¸íŠ¸ëŠ” ì¸ë„¤ì¼ ìœ ë¬´ì™€ ê´€ê³„ì—†ì´ ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬í•˜ê³  ìˆì–´, ë¡œë”© ì§€ì—° ë° ì˜¤ë¥˜ ë°œìƒ


// âœ… ëª©í‘œ
// 1. ê¸°ì¡´ ì´ë¯¸ì§€ë“¤ì— ëŒ€í•´ ì¸ë„¤ì¼ì„ ìƒì„±í•˜ê³  DBì— ì €ì¥
// 2. API ì‘ë‹µ ì‹œ thumbnailUrlì´ ì—†ìœ¼ë©´ originalUrlë¡œ ëŒ€ì²´(fallback)
// 3. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì´ë¯¸ì§€ë¡œ ì²˜ë¦¬


// âœ… 1ë‹¨ê³„: ì„œë²„ì—ì„œ ê¸°ì¡´ ì´ë¯¸ì§€ ì „ì²´ì— ëŒ€í•´ ì¸ë„¤ì¼ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

// ğŸ“ server/scripts/generate-thumbnails.ts (ìƒˆ íŒŒì¼)
// ìˆœì„œ:
// - uploads/ í´ë”ì˜ ëª¨ë“  ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸
// - ì¸ë„¤ì¼ì´ ì—†ëŠ” ê²½ìš° thumbnails/ í´ë”ì— 300x300 ì‚¬ì´ì¦ˆë¡œ ìƒì„±
// - DB.images í…Œì´ë¸”ì˜ thumbnail_url í•„ë“œë„ ì—…ë°ì´íŠ¸

// ì˜ˆì‹œ ì½”ë“œ:
import fs from 'fs';
import path from 'path';
import sharp from 'sharp';
import { db } from '../db';

const uploadsPath = path.join(process.cwd(), 'uploads');
const thumbnailsPath = path.join(uploadsPath, 'thumbnails');

async function generateThumbnails() {
  const images = await db.images.findMany();

  for (const image of images) {
    if (!image.original_url) continue;
    const filename = path.basename(image.original_url);
    const thumbnailFile = path.join(thumbnailsPath, filename);

    if (!fs.existsSync(thumbnailFile)) {
      await sharp(path.join(uploadsPath, filename))
        .resize(300, 300)
        .toFile(thumbnailFile);
    }

    await db.images.update({
      where: { id: image.id },
      data: { thumbnail_url: `/uploads/thumbnails/${filename}` },
    });
  }
  console.log('âœ… ëª¨ë“  ì¸ë„¤ì¼ ìƒì„± ì™„ë£Œ');
}

generateThumbnails();


// âœ… 2ë‹¨ê³„: API ì‘ë‹µì—ì„œ ì¸ë„¤ì¼ì´ ì—†ìœ¼ë©´ originalUrl ì‚¬ìš©í•˜ë„ë¡ fallback ì²˜ë¦¬

// server/routes.ts
const url = image.thumbnail_url ?? image.original_url;
res.json({ ...image, url });


// âœ… 3ë‹¨ê³„: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì²˜ë¦¬
// gallery-simplified.tsx, maternity-photo.tsx ë“±

<img
  src={image.url}
  alt={image.title}
  onError={(e) => {
    e.currentTarget.src = '/static/fallback-thumbnail.jpg';
  }}
  loading="lazy"
  width="300"
/>


// âœ… í…ŒìŠ¤íŠ¸ í•­ëª©
// - [ ] ì„œë²„ ì‹¤í–‰ í›„ ëª¨ë“  uploads íŒŒì¼ì— thumbnails ìƒì„±ë¨
// - [ ] DBì˜ thumbnail_url í•„ë“œê°€ ì±„ì›Œì§
// - [ ] ì¸ë„¤ì¼ì´ ì—†ë˜ ì´ë¯¸ì§€ë„ ë¹ ë¥´ê²Œ ë¡œë”©ë¨
// - [ ] 500 ì˜¤ë¥˜ ì‚¬ë¼ì§
// - [ ] ì´ë¯¸ì§€ê°€ ê¹¨ì¡Œì„ ê²½ìš° fallback ì´ë¯¸ì§€ê°€ ë‚˜íƒ€ë‚¨


// ğŸ” ì´ ì‘ì—…ì€ ì‚¬ì´íŠ¸ ì „ì²´ UX ê°œì„ ì— ë§¤ìš° ì¤‘ìš”í•˜ë©°, ì´ˆê¸° ì„±ëŠ¥ ì¸ì‹ì— ê²°ì •ì ì¸ ì—­í• ì„ í•˜ë¯€ë¡œ ë°˜ë“œì‹œ ìš°ì„  ì ìš©í•  ê²ƒ