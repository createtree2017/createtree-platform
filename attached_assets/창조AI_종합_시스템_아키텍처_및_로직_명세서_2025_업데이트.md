# 창조AI 종합 시스템 아키텍처 및 로직 명세서 (2025년 업데이트)

## 1. 시스템 개요

### 1.1 프로젝트 핵심 목적

이 애플리케이션은 **AI 병원 문화센터 플랫폼**으로, 산부인과 병원 고객을 대상으로 하는 문화센터 웹사이트입니다. **PUBLIC 배너 저장소 시스템**을 운영하며, **HIPAA 의료 보안 제한이 없는** 일반 문화 서비스를 제공합니다.

주요 기능:
- **AI 음악 생성**: TopMediai API를 통한 맞춤형 음악 생성 (태교음악, 자장가 등)
- **AI 이미지 생성**: OpenAI DALL-E 3와 Google Gemini를 통한 이미지 변환 및 생성
- **콜라주 생성**: 여러 이미지를 조합한 콜라주 제작
- **병원 회원 관리**: QR 코드 기반 병원별 회원 등록 및 관리
- **마일스톤 시스템**: 임신 기간별 마일스톤 추적 및 참여형 캠페인
- **갤러리 시스템**: 반응형 모바일 최적화 갤러리
- **관리자 시스템**: 병원 관리자용 캠페인 관리 도구
- **PWA 지원**: Progressive Web App으로 모바일 최적화

### 1.2 기술 스택 (Tech Stack)

| 카테고리 | 기술 | 버전 | 용도 |
|---------|------|------|------|
| **런타임** | Node.js | 20.x | 서버 런타임 |
| **언어** | TypeScript | 5.6.3 | 전체 프로젝트 타입 안전성 |
| **백엔드 프레임워크** | Express.js | 4.21.2 | REST API 서버 |
| **프론트엔드 프레임워크** | React | 18.3.1 | SPA UI 프레임워크 |
| **라우팅** | Wouter | 3.3.5 | 클라이언트 라우팅 |
| **UI 컴포넌트** | Radix UI + shadcn/ui | Latest | 접근성 기반 UI 컴포넌트 |
| **스타일링** | Tailwind CSS | 3.4.14 | 유틸리티 기반 CSS |
| **데이터베이스** | PostgreSQL (Neon) | - | 관계형 데이터베이스 |
| **ORM** | Drizzle ORM | 0.38.4 | 타입 안전 SQL 쿼리 |
| **인증** | JWT + Firebase Auth | - | 이중 인증 시스템 |
| **세션 관리** | express-session | 1.18.1 | 서버 세션 관리 |
| **파일 저장** | Google Cloud Storage | 7.16.0 | 클라우드 파일 저장소 (PUBLIC) |
| **AI 서비스** | OpenAI API | 4.104.0 | GPT-4o, DALL-E 3 |
| **AI 서비스** | Google Generative AI | 0.24.1 | Gemini 2.5 Flash |
| **음악 생성** | TopMediai API | Custom | AI 음악 생성 |
| **상태 관리** | TanStack Query | 5.60.5 | 서버 상태 관리 |
| **폼 관리** | React Hook Form | 7.53.1 | 폼 유효성 검사 |
| **빌드 도구** | Vite | 5.4.9 | 개발 서버 및 번들링 |
| **PWA** | vite-plugin-pwa | 1.0.0 | Progressive Web App |
| **이미지 처리** | Sharp | 0.34.2 | 썸네일 생성 |
| **보안** | bcrypt | 5.1.1 | 비밀번호 해싱 |
| **보안** | helmet | 8.1.0 | HTTP 보안 헤더 |
| **QR 코드** | qrcode | 1.5.4 | QR 코드 생성 |
| **이메일** | nodemailer | 7.0.4 | 이메일 발송 |

### 1.3 프로젝트 파일 구조

```
프로젝트 루트/
├── client/                   # 프론트엔드 React 애플리케이션
│   ├── public/              # 정적 파일
│   │   ├── icons/           # PWA 아이콘
│   │   └── manifest.json    # PWA 매니페스트
│   └── src/
│       ├── components/      # React 컴포넌트
│       │   ├── admin/       # 관리자 컴포넌트
│       │   ├── CollageBuilder/  # 콜라주 빌더
│       │   ├── gallery/     # 갤러리 컴포넌트
│       │   ├── hospital/    # 병원 관련 컴포넌트
│       │   ├── MilestoneApplication/  # 마일스톤 신청
│       │   ├── MusicGenerator/  # 음악 생성 UI
│       │   └── ui/          # shadcn/ui 컴포넌트
│       ├── pages/           # 라우트 페이지
│       │   ├── admin/       # 관리자 페이지
│       │   ├── hospital/    # 병원 페이지
│       │   └── signup/      # 회원가입 페이지
│       ├── hooks/           # React 커스텀 훅
│       ├── lib/             # 유틸리티 라이브러리
│       ├── stores/          # 상태 관리
│       ├── styles/          # 글로벌 스타일
│       └── App.tsx          # 메인 앱 컴포넌트
├── server/                  # 백엔드 Express 서버
│   ├── middleware/          # Express 미들웨어
│   │   ├── auth.ts          # JWT 인증
│   │   ├── admin-auth.ts    # 관리자 권한
│   │   ├── permission.ts    # 권한 관리
│   │   ├── rate-limiter.ts  # API 속도 제한
│   │   └── error-handler.ts # 에러 처리
│   ├── routes/              # API 라우트
│   │   ├── admin-routes.ts  # 관리자 API
│   │   ├── auth.ts          # 인증 API
│   │   ├── collage.ts       # 콜라주 API
│   │   ├── google-oauth.ts  # Google OAuth
│   │   ├── hospital-routes.ts # 병원 관리 API
│   │   ├── image.ts         # 이미지 생성 API
│   │   ├── music-engine-routes.ts # 음악 생성 API
│   │   └── upload.js        # GCS 업로드 API
│   ├── services/            # 비즈니스 로직 서비스
│   │   ├── auth.ts          # 인증 서비스
│   │   ├── collageServiceV2.ts # 콜라주 생성
│   │   ├── email.ts         # 이메일 발송
│   │   ├── firebase-auth.ts # Firebase 인증
│   │   ├── gemini.ts        # Google Gemini API
│   │   ├── milestones.ts    # 마일스톤 관리
│   │   ├── openai-dalle3.ts # DALL-E 3 이미지
│   │   └── topmedia-service.ts # TopMediai 음악
│   ├── utils/               # 유틸리티 함수
│   │   ├── gcs-image-storage.ts # GCS 이미지 저장
│   │   └── thumbnail.ts     # 썸네일 생성
│   ├── index.ts             # 서버 진입점
│   ├── routes.ts            # 라우트 등록
│   ├── storage.ts           # 데이터베이스 쿼리
│   └── vite.ts              # Vite 개발 서버
├── shared/                  # 공유 코드
│   ├── schema.ts            # Drizzle ORM 스키마
│   ├── constants.ts         # 공통 상수
│   └── qr-config.ts         # QR 설정
├── db/                      # 데이터베이스
│   ├── index.ts             # DB 연결
│   └── seed.ts              # 시드 데이터
├── static/                  # PUBLIC 정적 파일 (의료 보안 제한 없음)
│   ├── banner/              # 배너 이미지
│   ├── collages/            # 콜라주 이미지
│   └── milestones/          # 마일스톤 이미지
├── attached_assets/         # 첨부 파일
├── package.json             # 의존성 관리
├── vite.config.ts           # Vite 설정
├── tailwind.config.ts       # Tailwind 설정
├── drizzle.config.ts        # Drizzle 설정
├── replit.md               # 프로젝트 문서
└── .env                    # 환경 변수
```

## 2. 백엔드 아키텍처

### 2.1 API 엔드포인트 전체 명세

#### 2.1.1 인증 관련 API

| HTTP Method | URL Path | 담당 파일 | 인증 필요 여부 | 간단한 설명 | Request Body (JSON 형식) | Success Response (JSON 형식) |
|------------|----------|----------|---------------|------------|--------------------------|------------------------------|
| GET | /api/auth/check-username/:username | auth.ts | false | 사용자명 중복 체크 | N/A | { "available": boolean, "message": string } |
| POST | /api/auth/register | auth.ts | false | 신규 사용자 회원가입 | { "username", "password", "email", "fullName", "phoneNumber", "birthdate", "hospitalId", "promoCode" } | { "user": {...}, "accessToken", "message" } |
| POST | /api/auth/login | auth.ts | false | 사용자 로그인 | { "username", "password" } | { "accessToken", "user": {...} } |
| POST | /api/auth/logout | auth.ts | true | 로그아웃 | N/A | { "message": "로그아웃되었습니다" } |
| GET | /api/auth/me | auth.ts | true | 현재 로그인 사용자 정보 | N/A | { "success": true, "user": {...} } |
| PUT | /api/auth/profile | auth.ts | true | 프로필 업데이트 | { "fullName", "email", "phoneNumber", "dueDate", "birthdate" } | { "success": true, "user": {...} } |
| POST | /api/auth/firebase | auth.ts | false | Firebase 소셜 로그인 | { "firebaseToken" } | { "user": {...}, "token", "isNewUser" } |
| POST | /api/auth/forgot-password | auth.ts | false | 비밀번호 재설정 요청 | { "identifier" } | { "success": true, "message" } |
| POST | /api/auth/reset-password | auth.ts | false | 비밀번호 재설정 | { "token", "newPassword" } | { "success": true, "message" } |
| POST | /api/auth/google | google-oauth.ts | false | Google OAuth 로그인 | { "idToken" } | { "user": {...}, "token", "isNewUser" } |

#### 2.1.2 음악 생성 API

| HTTP Method | URL Path | 담당 파일 | 인증 필요 여부 | 간단한 설명 | Request Body (JSON 형식) | Success Response (JSON 형식) |
|------------|----------|----------|---------------|------------|--------------------------|------------------------------|
| POST | /api/music/generate | music-engine-routes.ts | true | AI 음악 생성 요청 | { "prompt", "style", "duration", "gender", "instrumental" } | { "success": true, "musicId", "message" } |
| GET | /api/music/status/:id | music-engine-routes.ts | true | 음악 생성 상태 확인 | N/A | { "success": true, "status", "url", "progress" } |
| GET | /api/music/styles | music-engine-routes.ts | false | 음악 스타일 목록 | N/A | [{ "id", "value", "label", "description" }] |
| GET | /api/music/stream/:id | server/index.ts | false | 음악 스트리밍 | N/A | Audio stream |
| DELETE | /api/music/:id | music-engine-routes.ts | true | 음악 삭제 | N/A | { "success": true } |

#### 2.1.3 이미지 생성 API

| HTTP Method | URL Path | 담당 파일 | 인증 필요 여부 | 간단한 설명 | Request Body (JSON 형식) | Success Response (JSON 형식) |
|------------|----------|----------|---------------|------------|--------------------------|------------------------------|
| POST | /api/images/transform | image.ts | true | AI 이미지 변환 | { "imageUrl", "conceptId", "style", "model" } | { "success": true, "transformedUrl", "thumbnailUrl" } |
| POST | /api/images/generate | image.ts | true | AI 이미지 생성 | { "prompt" } | { "success": true, "imageUrl" } |
| GET | /api/gallery | image.ts | true | 이미지 갤러리 조회 (모바일 반응형) | N/A | { "images": [...], "total", "page" } |
| DELETE | /api/images/:id | image.ts | true | 이미지 삭제 | N/A | { "success": true } |

#### 2.1.4 콜라주 API

| HTTP Method | URL Path | 담당 파일 | 인증 필요 여부 | 간단한 설명 | Request Body (JSON 형식) | Success Response (JSON 형식) |
|------------|----------|----------|---------------|------------|--------------------------|------------------------------|
| POST | /api/collage/generate | collage.ts | true | 콜라주 생성 | { "images", "layout", "title", "backgroundColor" } | { "success": true, "collageUrl" } |
| POST | /api/collage/download | collage.ts | true | 콜라주 다운로드 | { "dataUrl", "title", "style" } | { "success": true, "url", "id" } |
| GET | /api/collage/gallery | collage.ts | true | 콜라주 갤러리 | N/A | { "collages": [...] } |

#### 2.1.5 관리자 API

| HTTP Method | URL Path | 담당 파일 | 인증 필요 여부 | 간단한 설명 | Request Body (JSON 형식) | Success Response (JSON 형식) |
|------------|----------|----------|---------------|------------|--------------------------|------------------------------|
| GET | /api/admin/users | admin-routes.ts | admin | 사용자 목록 조회 | N/A | { "users": [...], "total" } |
| PUT | /api/admin/users/:id | admin-routes.ts | admin | 사용자 정보 수정 | { "memberType", "hospitalId", ... } | { "success": true, "user": {...} } |
| DELETE | /api/admin/users/:id | admin-routes.ts | admin | 사용자 삭제 | N/A | { "success": true } |
| GET | /api/admin/hospitals | admin-routes.ts | admin | 병원 목록 조회 | N/A | { "hospitals": [...] } |
| POST | /api/admin/hospitals | admin-routes.ts | admin | 병원 등록 | { "name", "slug", "address", "phone" } | { "success": true, "hospital": {...} } |
| PUT | /api/admin/hospitals/:id | admin-routes.ts | admin | 병원 정보 수정 | { "name", "isActive", ... } | { "success": true, "hospital": {...} } |
| GET | /api/admin/concepts | admin-routes.ts | admin | 컨셉 목록 조회 | N/A | { "concepts": [...] } |
| POST | /api/admin/concepts | admin-routes.ts | admin | 컨셉 생성 | { "conceptId", "title", "promptTemplate", ... } | { "success": true, "concept": {...} } |
| PUT | /api/admin/concepts/:id | admin-routes.ts | admin | 컨셉 수정 | { "title", "isActive", ... } | { "success": true, "concept": {...} } |

#### 2.1.6 병원 관리 API

| HTTP Method | URL Path | 담당 파일 | 인증 필요 여부 | 간단한 설명 | Request Body (JSON 형식) | Success Response (JSON 형식) |
|------------|----------|----------|---------------|------------|--------------------------|------------------------------|
| GET | /api/hospital/members | hospital-routes.ts | hospital_admin | 병원 회원 목록 | N/A | { "members": [...], "total" } |
| GET | /api/hospital/dashboard | hospital-routes.ts | hospital_admin | 병원 대시보드 | N/A | { "stats": {...}, "recentMembers": [...] } |
| POST | /api/hospital/codes | hospital-routes.ts | hospital_admin | 병원 코드 생성 | { "codeType", "maxUsage", "description" } | { "success": true, "code": {...} } |
| GET | /api/hospital/codes | hospital-routes.ts | hospital_admin | 병원 코드 목록 | N/A | { "codes": [...] } |
| DELETE | /api/hospital/codes/:id | hospital-routes.ts | hospital_admin | 병원 코드 삭제 | N/A | { "success": true } |
| GET | /api/hospital/qr/:code | hospital-routes.ts | false | QR 코드 정보 조회 | N/A | { "hospital": {...}, "code": {...} } |

#### 2.1.7 마일스톤 API

| HTTP Method | URL Path | 담당 파일 | 인증 필요 여부 | 간단한 설명 | Request Body (JSON 형식) | Success Response (JSON 형식) |
|------------|----------|----------|---------------|------------|--------------------------|------------------------------|
| GET | /api/milestones | routes.ts | false | 마일스톤 목록 | N/A | { "milestones": [...] } |
| POST | /api/milestones/:id/apply | routes.ts | true | 마일스톤 신청 | { "applicationData" } | { "success": true, "application": {...} } |
| GET | /api/milestone-applications | routes.ts | true | 내 신청 목록 | N/A | { "applications": [...] } |
| POST | /api/milestone-applications/:id/files | routes.ts | true | 파일 업로드 | FormData | { "success": true, "file": {...} } |
| GET | /api/milestone-applications/:id/files | routes.ts | true | 파일 목록 | N/A | { "files": [...], "stats": {...} } |

#### 2.1.8 PUBLIC 배너 및 기타 API (의료 보안 제한 없음)

| HTTP Method | URL Path | 담당 파일 | 인증 필요 여부 | 간단한 설명 | Request Body (JSON 형식) | Success Response (JSON 형식) |
|------------|----------|----------|---------------|------------|--------------------------|------------------------------|
| GET | /api/banners | routes.ts | false | 슬라이드 배너 목록 (PUBLIC) | N/A | [{ "id", "title", "imageUrl", ... }] |
| GET | /api/small-banners | routes.ts | false | 소형 배너 목록 (PUBLIC) | N/A | [{ "id", "title", "imageUrl", ... }] |
| GET | /api/menu | routes.ts | false | 메뉴 항목 목록 | N/A | [{ "id", "title", "icon", "items": [...] }] |
| POST | /api/chat | routes.ts | true | AI 채팅 | { "message", "personaSystemPrompt" } | { "response": "..." } |
| GET | /api/personas | routes.ts | false | 페르소나 목록 | N/A | { "personas": [...], "categories": [...] } |
| POST | /api/gcs-test | routes.ts | false | GCS 업로드 테스트 (PUBLIC) | FormData | { "success": true, "url", "gsPath" } |

### 2.2 데이터베이스 스키마

#### 2.2.1 users 테이블

| Column | Data Type | Constraints | 설명 |
|--------|-----------|------------|------|
| id | SERIAL | PRIMARY KEY | 사용자 고유 ID |
| username | TEXT | UNIQUE, NOT NULL | 사용자 로그인 아이디 |
| password | TEXT | | 해싱된 비밀번호 (소셜 로그인은 NULL 가능) |
| email | VARCHAR(255) | UNIQUE | 사용자 이메일 |
| fullName | VARCHAR(100) | | 전체 이름 |
| emailVerified | BOOLEAN | DEFAULT false | 이메일 인증 여부 |
| memberType | VARCHAR(20) | DEFAULT 'free' | 회원 등급 (free, pro, membership, hospital_admin, admin, superadmin) |
| hospitalId | INTEGER | FOREIGN KEY | 소속 병원 ID |
| promoCode | VARCHAR(50) | | 프로모션 코드 |
| lastLogin | TIMESTAMP | | 마지막 로그인 시간 |
| phoneNumber | VARCHAR(20) | | 전화번호 |
| dueDate | TIMESTAMP | | 출산 예정일 |
| birthdate | TIMESTAMP | | 생년월일 |
| firebaseUid | VARCHAR(128) | UNIQUE | Firebase 고유 ID |
| needProfileComplete | BOOLEAN | DEFAULT true | 프로필 완성 필요 여부 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 생성 시간 |
| updatedAt | TIMESTAMP | DEFAULT NOW() | 수정 시간 |

#### 2.2.2 hospitals 테이블

| Column | Data Type | Constraints | 설명 |
|--------|-----------|------------|------|
| id | SERIAL | PRIMARY KEY | 병원 고유 ID |
| name | TEXT | NOT NULL | 병원 이름 |
| slug | TEXT | UNIQUE, NOT NULL | 병원 URL 슬러그 |
| address | TEXT | | 병원 주소 |
| phone | TEXT | | 병원 전화번호 |
| email | TEXT | | 병원 이메일 |
| domain | TEXT | | 커스텀 도메인 |
| logoUrl | TEXT | | 병원 로고 URL |
| themeColor | TEXT | | 테마 색상 |
| contractStartDate | TIMESTAMP | | 계약 시작일 |
| contractEndDate | TIMESTAMP | | 계약 종료일 |
| packageType | TEXT | DEFAULT 'basic' | 패키지 타입 (basic, premium, enterprise) |
| isActive | BOOLEAN | DEFAULT true | 활성화 상태 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 생성 시간 |
| updatedAt | TIMESTAMP | DEFAULT NOW() | 수정 시간 |

#### 2.2.3 music 테이블

| Column | Data Type | Constraints | 설명 |
|--------|-----------|------------|------|
| id | SERIAL | PRIMARY KEY | 음악 고유 ID |
| title | TEXT | NOT NULL | 음악 제목 |
| prompt | TEXT | NOT NULL | 사용자 프롬프트 |
| style | TEXT | | 음악 스타일 |
| translatedPrompt | TEXT | | 영어 번역 프롬프트 |
| tags | JSONB | DEFAULT '[]' | 스타일 태그 |
| url | TEXT | | 최종 오디오 파일 URL (GCS PUBLIC) |
| lyrics | TEXT | | 생성된 가사 |
| instrumental | BOOLEAN | DEFAULT false | 반주 전용 여부 |
| duration | INTEGER | DEFAULT 60 | 음악 길이(초) |
| userId | INTEGER | | 사용자 ID |
| provider | TEXT | DEFAULT 'topmedia' | 음악 생성 제공자 |
| creditUsed | INTEGER | DEFAULT 1 | 사용된 크레딧 |
| engine | VARCHAR(20) | DEFAULT 'topmedia' | 사용된 엔진 (topmedia, suno) |
| engineTaskId | VARCHAR(100) | | 엔진별 작업 ID |
| fallbackUsed | BOOLEAN | DEFAULT false | 폴백 엔진 사용 여부 |
| gcsPath | VARCHAR(500) | | GCS 저장 경로 (PUBLIC) |
| contentType | VARCHAR(50) | DEFAULT 'audio/mpeg' | MIME 타입 |
| durationSec | INTEGER | | 실제 음악 길이(초) |
| status | TEXT | DEFAULT 'pending' | 생성 상태 (pending, processing, done, error) |
| songId | TEXT | | TopMediai song_id |
| generateLyrics | BOOLEAN | DEFAULT false | 가사 자동 생성 여부 |
| gender | TEXT | | 가수 성별 (female, male, child, auto) |
| hospitalId | INTEGER | FOREIGN KEY | 병원 ID |
| metadata | JSONB | DEFAULT '{}' | 추가 메타데이터 |
| isFavorite | BOOLEAN | DEFAULT false | 즐겨찾기 여부 |
| isPublic | BOOLEAN | DEFAULT false | 공개 여부 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 생성 시간 |
| updatedAt | TIMESTAMP | DEFAULT NOW() | 수정 시간 |

#### 2.2.4 images 테이블

| Column | Data Type | Constraints | 설명 |
|--------|-----------|------------|------|
| id | SERIAL | PRIMARY KEY | 이미지 고유 ID |
| title | TEXT | NOT NULL | 이미지 제목 |
| style | TEXT | NOT NULL | 이미지 스타일 |
| originalUrl | TEXT | NOT NULL | 원본 이미지 URL (GCS PUBLIC) |
| transformedUrl | TEXT | NOT NULL | 변환된 이미지 URL (GCS PUBLIC) |
| thumbnailUrl | TEXT | | 썸네일 URL (GCS PUBLIC) |
| metadata | TEXT | DEFAULT '{}' | 메타데이터 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 생성 시간 |
| userId | VARCHAR(128) | | 사용자 ID (이메일 또는 Firebase UID) |
| categoryId | VARCHAR(50) | | 카테고리 ID |
| conceptId | VARCHAR(50) | | 컨셉 ID |
| styleId | VARCHAR(50) | | 스타일 ID |

#### 2.2.5 smallBanners 테이블 (PUBLIC)

| Column | Data Type | Constraints | 설명 |
|--------|-----------|------------|------|
| id | SERIAL | PRIMARY KEY | 소형 배너 고유 ID |
| title | TEXT | NOT NULL | 배너 제목 |
| description | TEXT | | 배너 설명 |
| imageUrl | TEXT | NOT NULL | 배너 이미지 URL (PUBLIC) |
| linkUrl | TEXT | | 클릭 시 이동할 URL |
| isActive | BOOLEAN | DEFAULT true | 활성화 상태 |
| order | INTEGER | DEFAULT 0 | 정렬 순서 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 생성 시간 |
| updatedAt | TIMESTAMP | DEFAULT NOW() | 수정 시간 |

#### 2.2.6 hospitalCodes 테이블

| Column | Data Type | Constraints | 설명 |
|--------|-----------|------------|------|
| id | SERIAL | PRIMARY KEY | 코드 고유 ID |
| hospitalId | INTEGER | FOREIGN KEY, NOT NULL | 병원 ID |
| code | VARCHAR(20) | UNIQUE, NOT NULL | 인증 코드 |
| codeType | VARCHAR(20) | NOT NULL | 코드 타입 (master, limited, qr_unlimited, qr_limited) |
| maxUsage | INTEGER | | 최대 사용 횟수 (NULL = 무제한) |
| currentUsage | INTEGER | DEFAULT 0 | 현재 사용 횟수 |
| isQREnabled | BOOLEAN | DEFAULT false | QR 코드 활성화 |
| qrDescription | VARCHAR(100) | | QR 코드 설명 |
| isActive | BOOLEAN | DEFAULT true | 활성화 상태 |
| expiresAt | TIMESTAMP | | 만료 시간 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 생성 시간 |
| updatedAt | TIMESTAMP | DEFAULT NOW() | 수정 시간 |

### 2.3 인증 및 권한 부여 로직

#### 2.3.1 JWT 페이로드 구조

```typescript
interface JWTPayload {
  id: number;           // 사용자 ID
  userId: number;       // 하위 호환성을 위한 중복 필드
  email: string | null;
  memberType: string | null;  // free, pro, membership, hospital_admin, admin, superadmin
  hospitalId?: number | null;
  username?: string;
  iat?: number;         // 토큰 발급 시간
  exp?: number;         // 토큰 만료 시간
}
```

#### 2.3.2 인증 미들웨어 처리 순서

1. **토큰 추출**: 
   - 쿠키에서 `auth_token` 확인
   - 없으면 Authorization 헤더에서 `Bearer` 토큰 확인

2. **토큰 검증**: 
   - `jwt.verify(token, JWT_SECRET)` 실행
   - 만료 여부 확인
   - 서명 유효성 확인

3. **사용자 정보 주입**:
   - 검증 성공 시 `req.user`에 디코딩된 사용자 정보 할당
   - 다음 미들웨어로 전달

4. **권한 검증**:
   - `requireAdminOrSuperAdmin`: memberType이 'admin' 또는 'superadmin' 확인
   - `requireHospitalAdmin`: memberType이 'hospital_admin' 및 hospitalId 존재 확인
   - `requireActiveHospital`: 병원 활성화 상태 추가 확인

## 3. 프론트엔드 아키텍처

### 3.1 React 컴포넌트 구조

```
client/src/components/
├── ui/                    # shadcn/ui 기본 컴포넌트
│   ├── button.tsx
│   ├── input.tsx
│   ├── form.tsx
│   └── toast.tsx
├── admin/                 # 관리자 전용 컴포넌트
│   ├── ConceptManagement.tsx
│   ├── HospitalDashboard.tsx
│   └── UserManagement.tsx
├── gallery/               # 갤러리 시스템 (모바일 반응형)
│   ├── GalleryEmbedSimple.tsx
│   ├── ImageGrid.tsx
│   └── FilterMenu.tsx
├── hospital/              # 병원 관련 컴포넌트
│   ├── HospitalCodeManager.tsx
│   ├── MemberDashboard.tsx
│   └── QRCodeDisplay.tsx
├── MusicGenerator/        # 음악 생성 UI
│   ├── MusicGenerationForm.tsx
│   ├── StyleSelector.tsx
│   └── AudioPlayer.tsx
├── CollageBuilder/        # 콜라주 빌더
│   ├── CollageEditor.tsx
│   ├── ImageUploader.tsx
│   └── LayoutSelector.tsx
└── MilestoneApplication/  # 마일스톤 신청
    ├── MilestoneCard.tsx
    ├── ApplicationForm.tsx
    └── FileUploader.tsx
```

### 3.2 상태 관리 (State Management)

#### 3.2.1 TanStack Query 구조

```typescript
// 주요 쿼리 키 구조
const queryKeys = {
  gallery: ['gallery'] as const,
  music: ['music'] as const,
  milestones: ['milestones'] as const,
  hospitals: ['hospitals'] as const,
  admin: {
    users: ['admin', 'users'] as const,
    concepts: ['admin', 'concepts'] as const,
  }
};

// 갤러리 쿼리 (모바일 반응형)
const useGalleryQuery = (filter: string) => {
  return useQuery({
    queryKey: [...queryKeys.gallery, filter],
    queryFn: () => fetch(`/api/gallery?filter=${filter}`).then(res => res.json())
  });
};
```

#### 3.2.2 인증 상태 관리

```typescript
// 인증 관련 쿼리
const useAuthQuery = () => {
  return useQuery({
    queryKey: ['auth', 'me'],
    queryFn: () => fetch('/api/auth/me').then(res => res.json()),
    retry: false,
    staleTime: 5 * 60 * 1000 // 5분
  });
};
```

### 3.3 모바일 반응형 디자인

#### 3.3.1 갤러리 필터 메뉴 (flex-wrap 적용)

```tsx
// 모바일에서 자동 줄바꿈되는 필터 메뉴
<div className="flex flex-wrap gap-2 mb-6">
  {filters.map((filter) => (
    <Button
      key={filter}
      variant={activeFilter === filter ? "default" : "outline"}
      onClick={() => setActiveFilter(filter)}
      className="flex-shrink-0"
    >
      {getFilterLabel(filter)}
    </Button>
  ))}
</div>
```

## 4. 보안 및 데이터 관리

### 4.1 PUBLIC 스토리지 시스템 (의료 보안 제한 없음)

이 시스템은 **병원 문화센터**를 위한 플랫폼으로, **HIPAA 의료 보안 제한이 적용되지 않습니다**. 모든 배너와 이미지는 PUBLIC 스토리지에 저장됩니다.

#### 4.1.1 Google Cloud Storage 구조

```
createtree-upload/ (PUBLIC 버킷)
├── images/
│   ├── mansak_img/     # 만삭 사진
│   ├── family_img/     # 가족 사진
│   ├── baby_face_img/  # 아기 얼굴
│   ├── sticker_img/    # 스티커
│   └── thumbnails/     # 썸네일
├── music/              # 음악 파일
├── banners/            # 배너 이미지 (PUBLIC)
└── collages/           # 콜라주 이미지
```

#### 4.1.2 파일 URL 구조

```typescript
// PUBLIC URL 패턴 (의료 보안 제한 없음)
const publicImageUrl = `https://storage.googleapis.com/createtree-upload/images/${category}/${path}`;
const publicThumbnailUrl = `https://storage.googleapis.com/createtree-upload/images/${category}/thumbnails/${filename}`;
const publicBannerUrl = `https://storage.googleapis.com/createtree-upload/banners/${filename}`;
```

### 4.2 인증 및 권한 관리

#### 4.2.1 6단계 멤버십 시스템

| 등급 | 권한 | 설명 |
|------|------|------|
| free | 기본 기능 | 무료 사용자 |
| pro | 프리미엄 기능 | 유료 개인 사용자 |
| membership | 멤버십 혜택 | 멤버십 가입 사용자 |
| hospital_admin | 병원 관리 | 병원 관리자 |
| admin | 시스템 관리 | 시스템 관리자 |
| superadmin | 최고 권한 | 최고 관리자 |

#### 4.2.2 병원별 데이터 격리

```typescript
// 병원별 데이터 필터링
const getHospitalScopedData = async (userId: number, hospitalId: number) => {
  return await db.query.images.findMany({
    where: and(
      eq(images.userId, userId),
      eq(images.hospitalId, hospitalId)
    )
  });
};
```

## 5. AI 서비스 통합

### 5.1 음악 생성 시스템

#### 5.1.1 TopMediai API 통합

```typescript
// TopMediai 음악 생성 워크플로우
const generateMusic = async (prompt: string, style: string) => {
  // 1. TopMediai API 요청
  const taskId = await topMediaiAPI.createTask({
    prompt,
    style,
    duration: 60
  });
  
  // 2. 상태 폴링
  const result = await pollTaskStatus(taskId);
  
  // 3. GCS 업로드 (PUBLIC)
  const gcsUrl = await uploadToGCS(result.audioUrl, 'music');
  
  // 4. 데이터베이스 저장
  await db.insert(music).values({
    title: prompt,
    url: gcsUrl,
    status: 'done'
  });
};
```

### 5.2 이미지 생성 시스템

#### 5.2.1 멀티 AI 모델 지원

```typescript
// AI 모델 선택 시스템
const generateImage = async (prompt: string, model: 'openai' | 'gemini') => {
  let imageUrl: string;
  
  switch (model) {
    case 'openai':
      imageUrl = await openaiDalle3.generate(prompt);
      break;
    case 'gemini':
      imageUrl = await geminiVision.generate(prompt);
      break;
  }
  
  // WebP 변환 및 썸네일 생성
  const processedImage = await processImage(imageUrl);
  
  // GCS 업로드 (PUBLIC)
  const gcsUrl = await uploadToGCS(processedImage, 'images');
  
  return gcsUrl;
};
```

#### 5.2.2 이미지 카테고리 및 AI 모델 설명

- **mansak_img**: 만삭 사진 - **"OPEN AI(고품질, 감성적인)"**
- **family_img**: 가족 사진 - **"GEMINI(고품질, 일관성)"**
- **baby_face_img**: 아기 얼굴
- **sticker_img**: 스티커
- **collage**: 콜라주

## 6. 배포 및 운영

### 6.1 Replit 배포 시스템

#### 6.1.1 개발 vs 프로덕션

```bash
# 개발 환경 (Hot Module Replacement)
npm run dev  # 즉시 반영 (갤러리 flex-wrap 수정처럼)

# 프로덕션 배포
# 코드 변경사항은 republish 필요
```

#### 6.1.2 환경 변수

```env
# 데이터베이스
DATABASE_URL=postgresql://...

# AI 서비스
OPENAI_API_KEY=sk-...
GOOGLE_APPLICATION_CREDENTIALS=path/to/credentials.json

# GCS (PUBLIC 스토리지)
GCS_BUCKET_NAME=createtree-upload
GCS_PROJECT_ID=...

# 인증
JWT_SECRET=...
FIREBASE_ADMIN_KEY=...

# TopMediai
TOPMEDIA_API_KEY=...
TOPMEDIA_API_SECRET=...
```

### 6.2 성능 최적화

#### 6.2.1 이미지 최적화

- **WebP 변환**: 모든 이미지를 WebP 포맷으로 변환
- **썸네일 생성**: Sharp를 사용한 고성능 썸네일 생성
- **PUBLIC CDN**: GCS를 통한 글로벌 CDN 제공

#### 6.2.2 캐싱 전략

```typescript
// TanStack Query 캐싱 설정
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5분
      cacheTime: 10 * 60 * 1000, // 10분
    },
  },
});
```

## 7. 마일스톤 및 캠페인 시스템

### 7.1 마일스톤 관리

#### 7.1.1 마일스톤 타입

- **info**: 정보형 마일스톤
- **campaign**: 캠페인형 마일스톤 (참여 인원 제한)

#### 7.1.2 캠페인 기간 관리

```typescript
interface MilestoneCampaign {
  campaignStartDate: Date;
  campaignEndDate: Date;
  selectionStartDate: Date;
  selectionEndDate: Date;
  maxParticipants: number;
  currentParticipants: number;
}
```

## 8. 결론

이 **AI 병원 문화센터 플랫폼**은 산부인과 병원 고객을 위한 종합적인 문화 서비스를 제공합니다. **PUBLIC 스토리지 시스템**을 통해 의료 보안 제한 없이 자유로운 콘텐츠 공유가 가능하며, 모바일 반응형 디자인으로 모든 디바이스에서 최적화된 사용자 경험을 제공합니다.

### 8.1 주요 특징

1. **의료 보안 제한 없음**: PUBLIC 배너 및 이미지 저장소
2. **모바일 반응형**: flex-wrap을 통한 자동 레이아웃 조정
3. **AI 통합**: OpenAI (고품질, 감성적인), Gemini (고품질, 일관성), TopMediai 등 다중 AI 서비스
4. **병원별 관리**: QR 코드 기반 병원 회원 시스템
5. **실시간 업데이트**: Hot Module Replacement를 통한 개발 효율성

### 8.2 기술적 우수성

- **타입 안전성**: TypeScript와 Drizzle ORM을 통한 전체 스택 타입 안전성
- **현대적 스택**: React, Vite, TanStack Query 등 최신 기술 스택
- **확장성**: 모듈화된 아키텍처와 클라우드 네이티브 설계
- **성능**: 이미지 최적화, 캐싱, CDN을 통한 고성능 구현

이 플랫폼은 병원 고객들에게 AI 기반의 창조적이고 감성적인 콘텐츠 생성 경험을 제공하며, 임신과 육아 과정에서의 특별한 순간들을 기록하고 공유할 수 있는 종합적인 문화센터 역할을 수행합니다.