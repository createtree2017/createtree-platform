## ğŸ¯Â TopMediai í†µí•© ì˜¤ë¥˜Â â€“ ë¼í”Œ ì „ìš© **ì „ë©´ ìˆ˜ì • ì§€ì‹œì„œ (v2)**

> **ëª©ì **Â : Suno/Replicateâ€¯ì”ì¬ë¥¼ ì œê±°í•˜ê³  TopMediaâ€¯ì „ìš©ìœ¼ë¡œ ì„œë²„Â·DBÂ·í”„ë¡ íŠ¸ë¥¼ ì¬ì •ë ¬í•˜ì—¬ ìŒì•…Â·ê°€ì‚¬ ìƒì„±ì´ í•œë²ˆì— ì •ìƒ ì™„ë£Œâ€¯â†’â€¯DB ì €ì¥â€¯â†’â€¯ì¬ìƒê¹Œì§€ ì´ì–´ì§€ë„ë¡ í•œë‹¤.

---

### 1ï¸âƒ£Â ì—”ë“œí¬ì¸íŠ¸ ì¼ì›í™”

| ìš©ë„           | ìµœì¢… URL                                       | ë©”ì„œë“œ  | ë¹„ê³                                          |
| ------------ | -------------------------------------------- | ---- | ------------------------------------------ |
| **ê°€ì‚¬ ìƒì„±**    | `https://api.topmediai.com/v1/lyrics`        | POST | í˜„ì¬ "under maintenance"Â·ì‹¤íŒ¨ ì‹œ GPT ëŒ€ì²´ë¡œ ì¦‰ì‹œ ì „í™˜  |
| **ìŒì•… ì œì¶œ**    | `https://api.topmediai.com/v2/submit`        | POST | ì œì¶œ ì‘ë‹µÂ `{ id }`Â ìˆ˜ì‹                           |
| **ìŒì•… ìƒíƒœ ì¡°íšŒ** | `https://api.topmediai.com/v2/query?id=<id>` | GET  | Â `status:"success"`Â ë˜ëŠ”Â `audio_url` ì¡´ì¬ ì‹œ ì™„ë£Œ |

> ì½”ë“œì— ë‚¨ì•„ìˆëŠ” `aimusic-api.topmediai.com`, `music-api.*` ë“± **ëª¨ë‘ ì‚­ì œ**

---

### 2ï¸âƒ£Â ìš”ì²­ íŒŒë¼ë¯¸í„°Â (Basic)

```jsonc
{
  "prompt"       : "gentle lullaby for baby",   // í•„ìˆ˜ (1â€‘200ì)
  "model_version": "v4.0",                      // 'v4.0' Â· 'v3.5' Â· 'v3.0' ì¤‘ í•˜ë‚˜
  "instrumental" : 0,                           // 0 = ë³´ì»¬ í¬í•¨, 1 = ì—°ì£¼ë§Œ
  "is_auto"      : 1                            // 1 = ë©œë¡œë”” ìë™, 0 = ìˆ˜ë™(ê°€ì‚¬ í•„ìš”)
  // optional â†“
  "lyrics"       : "...",                      // ê°€ì‚¬ ì§ì ‘ ì…ë ¥ ì‹œ
  "gender"       : "female"                    // ë³´ì»¬ ì„±ë³„
}
```

---

### 3ï¸âƒ£Â DB ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”

| í•„ë“œ            | íƒ€ì…   | ê¸°ë³¸ê°’/ì œì•½       | ì•¡ì…˜                                             |
| ------------- | ---- | ------------ | ---------------------------------------------- |
| `style`       | text | NULL í—ˆìš©      | `ALTER TABLE music ALTER style DROP NOT NULL;` |
| `provider`    | text | `'topmedia'` | add if not exists                              |
| `status`      | text | `'pending'`  | add                                            |
| `credit_used` | int  | 0            | add                                            |

> **Drizzle** ìŠ¤í‚¤ë§ˆ(`shared/schema.ts`)ì™€ ì‹¤ì œ DB ë‘˜ ë‹¤ ë™ì¼í•˜ê²Œ ìˆ˜ì • í›„Â `npm run db:push`.

---

### 4ï¸âƒ£Â ì„œë¹„ìŠ¤ ë ˆì´ì–´ ì‘ì—…

#### a.Â `server/services/topmedia-service.ts`Â (ì‹ ê·œ/ì •ë¹„)

```ts
export async function submitTopMediaMusic(body){
  const { data } = await axios.post(SUBMIT_URL, body, hdr);
  return data?.data?.id; // id string
}
export async function pollTopMediaMusic(id){
  for(let i=0;i<40;i++){      // 120ì´ˆ ì œí•œ
    const { data } = await axios.get(`${QUERY_URL}?id=${id}`, hdr);
    if(data?.data?.audio_url){return data.data;}
    await sleep(3000);
  }
  throw new Error('TopMedia timeout');
}
```

#### b.Â `server/services/music-service.ts`

1. Suno/Replicate ë¶„ê¸° **ì „ë¶€ ì œê±°**
2. `generateMusic()` ë¡œì§ì„ TopMedia ì „ìš©ìœ¼ë¡œ ë‹¨ìˆœí™” â–¶ â‘ Â ê°€ì‚¬Â â‡’Â Lyricsâ€¯API ë˜ëŠ” GPTÂ â‘¡Â ìŒì•…Â submitÂ â–¶Â queryÂ â–¶Â audioUrlÂ â‘¢Â DB insert.
3. ì™„ë£Œ ê°ì§€ : `if (status==='success' || audio_url)` ì¦‰ì‹œ ì €ì¥.

---

### 4ï¸âƒ£â€‘1Â GCS ì—…ë¡œë“œ ì—°ë™ (í•„ìˆ˜)

* **íŒ¨í‚¤ì§€**Â `@google-cloud/storage`Â ì¶”ê°€ â€” `npm i @google-cloud/storage`
* **í™˜ê²½ë³€ìˆ˜**

  ```bash
  GCS_BUCKET_NAME=createtree-ai-music
  GOOGLE_APPLICATION_CREDENTIALS=/home/runner/secrets/gcs-sa.json
  ```
* **ì—…ë¡œë“œ ë¡œì§**Â (`topmedia-service.ts`Â ë§ˆì§€ë§‰ ë‹¨ê³„)

  ```ts
  import { Storage } from '@google-cloud/storage';
  const storage = new Storage();

  async function uploadToGCS(tmpFile: string, key: string) {
    const bucket = storage.bucket(process.env.GCS_BUCKET_NAME!);
    await bucket.upload(tmpFile, { destination: key, public: true });
    return `https://storage.googleapis.com/${process.env.GCS_BUCKET_NAME}/${key}`;
  }

  // â€¦ ê¸°ì¡´ TopMediai ì™„ë£Œ ì²˜ë¦¬ ì´í›„
  const localPath = await downloadAudio(topMediaAudioUrl); // temp mp3
  const gcsKey    = `music/${songId}.mp3`;
  const gcsUrl    = await uploadToGCS(localPath, gcsKey);
  await db.insert(music).values({ ...insertData, audio_url: gcsUrl });
  fs.unlinkSync(localPath);
  ```
* **DB**Â `audio_url`Â í•„ë“œì—ëŠ” **GCS URL** ì €ì¥ â†’Â í”„ë¡ íŠ¸ëŠ” ì´ URL ì§ì¬ìƒ
* **ë²„í‚· ê¶Œí•œ**Â : í¼ë¸”ë¦­Â `allUsers:objectViewer` ë˜ëŠ” Cloud CDNÂ Signedâ€‘URL ì‚¬ìš© ì¤‘ í•˜ë‚˜ ì„ íƒ

---

### 5ï¸âƒ£Â í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì •Â í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì •

* `client/src/components/music/MusicForm.tsx`

  * hidden `provider="topmedia"`
  * `style` ë“œë¡­ë‹¤ìš´ ì¶”ê°€ (lullaby, pop, jazzâ€¦)
* Suno ë©”ë‰´Â·í˜ì´ì§€ ë§í¬ **ì „ë¶€ ì‚­ì œ**

---

### 6ï¸âƒ£Â í™˜ê²½ë³€ìˆ˜

```
TOPMEDIA_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

ëŒ€ì²´ í‚¤ í•„ìš” ì—†ìŒâ€¯â€“â€¯í˜„ì¬ í‚¤ ì •ìƒ.

---

### 7ï¸âƒ£Â ê°€ì‚¬ API í´ë°± ë¡œì§

```ts
try{ await axios.post(LYRICS_URL, {prompt}, hdr) }
catch{ lyrics = await gptGenerateLyrics(prompt); }
```

---

### 8ï¸âƒ£Â í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ (â±Â 5ë¶„ ì´ë‚´ í†µê³¼)

1. `npm run dev`Â â€“ ì»´íŒŒì¼ ì—ëŸ¬ 0.
2. **POST**Â `/api/music/create`Â (í”„ë¡¬í”„íŠ¸ "í…ŒìŠ¤íŠ¸ ìì¥ê°€")Â â–¶Â ì‘ë‹µ 200.
3. ì„œë²„ ë¡œê·¸ â€‘Â `TopMedia submit id=â€¦` â†’ `audio_url=https://â€¦mp3` 120â€¯s ì´ë‚´ ì¶œë ¥.
4. DBÂ `music`Â ë ˆì½”ë“œ : `provider='topmedia'`, `status='done'`, `audio_url`Â ì±„ì›Œì§.
5. í”„ë¡ íŠ¸ ì¬ìƒ ë²„íŠ¼ â–¶ ì •ìƒ í”Œë ˆì´.

---

### 9ï¸âƒ£Â ë¼í”Œ ì‘ì—… ìˆœì„œ ìš”ì•½

```bash
# 0. Suno/Replicate íŒŒì¼ ì‚­ì œÂ·ë°±ì—…
# 1. env í‚¤ í™•ì¸
# 2. schema.ts + ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
# 3. topmedia-service.ts êµ¬í˜„
# 4. music-service.ts ë¦¬íŒ©í† ë§
# 5. í”„ë¡ íŠ¸ í¼/ë¼ìš°íŒ… ì •ë¦¬
# 6. npm run dev && í†µí•© í…ŒìŠ¤íŠ¸
```

> âš ï¸Â **Commitâ€¯ì „ `npx eslint . --fix && npx tsc -p .`Â ë°˜ë“œì‹œ í†µê³¼**

---

### âœ…Â ì‘ì—… ê²°ê³¼ ë³´ê³  ì²´í¬ë¦¬ìŠ¤íŠ¸

* [ ] Suno ê´€ë ¨ íŒŒì¼ ì „ë¶€ ì‚­ì œ/ë°±ì—… ìŠ¤í¬ë¦°ìƒ·
* [ ] DB ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œê·¸
* [ ] `audio_url` í¬í•¨ TopMedia ìµœì¢… ì‘ë‹µ JSON
* [ ] í”„ë¡ íŠ¸ì—ì„œ ì¬ìƒë˜ëŠ” í™•ì¸ GIF

ì´ ë¬¸ì„œëŒ€ë¡œ ì™„ë£Œ í›„ â€œ**TopMedia v2 í†µí•© ì™„ë£Œ**â€ ë¼ë²¨ ë‹¬ì•„ Slack #dev ë¡œ ê³µìœ  ë°”ëë‹ˆë‹¤.
