## 🛠️ [라플이 작업지시서] GCS 갤러리 이미지 표시 오류 및 DB/GCS 구조 복원 지시

### 🎯 목적
- 현재 갤러리에서 이미지가 보이지 않거나 중복 표시되는 문제를 해결
- DB 경로와 GCS 저장 구조의 불일치를 정리
- 정식서버와 개발서버의 구조 및 디자인을 통일하여 시스템 정상화

---

### ✅ Step 1: DB의 이미지 URL 구조 복원
- 다음 경로 형식으로 DB의 `original_url`과 `thumbnail_url`을 전부 수정:
  ```
  https://storage.googleapis.com/createtree-upload/images/{category}/{userId}/{filename}.webp
  https://storage.googleapis.com/createtree-upload/images/{category}/{userId}/thumbnails/{filename}.webp
  ```
- 수정 대상: `images` 테이블의 모든 레코드
- `uploads/...` 또는 `images/general/system/...` 형식은 **모두 제거**

---

### ✅ Step 2: GCS 파일 확인 및 경로 일치 검증
- `/server/scripts/check-gcs-files.ts` 사용
  - DB에서 사용된 모든 `original_url`, `thumbnail_url`을 추출
  - 실제 GCS 버킷에 존재하는지 확인
- 존재하지 않는 파일은 **절대 임의로 생성하지 말고**, 해당 레코드를 DB에서 제외

---

### ✅ Step 3: 갤러리 API 반환 구조 원상복구
- `/server/routes.ts` 또는 `/api/gallery` 내 반환 형식:
  ```ts
  {
    items: [
      {
        id: number,
        title: string,
        original_url: string,
        thumbnail_url: string,
        created_at: string,
        category: string,
        ...기타 필드
      }
    ]
  }
  ```
- 현재 `{images: [...]}` 또는 `[]` 배열 자체 반환 구조는 모두 제거
- `React Query`에서 `enabled: !!user` 조건은 제거 유지 가능, 다만 **데이터 구조는 원상복구**

---

### ✅ Step 4: 중복 이미지 자동 생성 로직 제거
- 다음 스크립트는 삭제 또는 주석 처리:
  - `/scripts/create-diverse-gallery.ts`
  - `/scripts/upload-missing-images.ts`
- DB에 동일한 `original_url`로 여러 개 생성된 레코드 모두 삭제
- 단일 대표 이미지만 유지 (title이 다른 경우라도 동일 이미지면 삭제)

---

### ✅ Step 5: 프론트 갤러리 UI 복원
- 기준은 정식서버 UI (회색 배경 + 카메라 아이콘 + 텍스트 포함):
  - placeholder: `bg-gray-200` + `items-center justify-center`
  - 텍스트: `"이미지를 준비 중"`, 이미지 로드 전 표시
  - grid: `2 x 4` 구조 유지
- 이미지 로딩 실패 시 fallback UI 적용

---

### ⛔ 절대 하지 말 것
- GCS 경로를 업로드 기준으로 임의로 바꾸지 말 것 (`uploads/` 제거)
- `createtree-upload` 외 다른 버킷 사용 금지
- OpenAI API 키 변경 금지 (`sk-proj-` 고정, 일반 `sk-` 키 절대 금지)

---

### 🔐 테스트 시 유의사항
- 사용자 ID: 24 기준으로 테스트
- `/api/gallery?type=images` 호출 시 `12개 이미지`가 GCS와 DB 모두 일치해야 성공
- 브라우저 콘솔 에러 `401`, `null.innerHTML`, `이미지 로드 실패` 등이 나타나면 즉시 중단하고 로그 확인